<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Life Position - 인생 포지션 분석</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,line-clamp"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <script>
        window.addEventListener('load', () => {
            const root = document.getElementById('root');
            if (!root) return;
            if (!window.React || !window.ReactDOM) {
                root.textContent = 'React 로딩 실패: 외부 CDN 연결을 확인해 주세요.';
                return;
            }
            if (!window.Babel) {
                root.textContent = 'Babel 로딩 실패: 외부 CDN 연결을 확인해 주세요.';
            }
        });
    </script>

    <!-- Theme Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#7f13ec",
                        "primary-light": "#9e4bf3",
                        "primary-lighter": "#efe6fd",
                        "background-light": "#f7f6f8",
                        "background-dark": "#191022",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a2235", // Combined/averaged from screens
                        "text-main": "#140d1b",
                        "text-sub": "#734c9a",
                        "secondary-text": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans KR", "sans-serif"],
                        "sans": ["Plus Jakarta Sans", "Noto Sans KR", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "1rem", 
                        "lg": "2rem", 
                        "xl": "3rem", 
                        "full": "9999px",
                        "md": "0.5rem",
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    },
                    boxShadow: {
                        "soft": "0 4px 20px -2px rgba(127, 19, 236, 0.08)",
                        "glow": "0 0 15px rgba(127, 19, 236, 0.3)",
                        "card": "0 2px 8px rgba(0, 0, 0, 0.04)",
                    }
                },
            },
        }
    </script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            min-height: 100dvh;
            background-color: #f7f6f8;
        }
        .text-gradient {
            background: linear-gradient(135deg, #7f13ec 0%, #b06bf7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .peer:checked ~ .card-ring {
            border-color: #7f13ec;
            background-color: rgba(127, 19, 236, 0.03);
            box-shadow: 0 4px 12px rgba(127, 19, 236, 0.1);
        }
        .peer:checked ~ .card-ring .radio-indicator {
            background-color: #7f13ec;
            border-color: #7f13ec;
        }
        .peer:checked ~ .card-ring .radio-indicator::after {
            transform: scale(1);
        }
        .radio-indicator::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .card-stack {
            position: relative;
            height: 320px;
            width: 220px;
            margin: 0 auto;
            perspective: 1000px;
        }
        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(135deg, #1f122e 0%, #7f13ec 100%);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: bottom center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
        }
        .card:nth-child(1) { transform: rotate(-10deg) translateY(10px); z-index: 1; }
        .card:nth-child(2) { transform: rotate(-5deg) translateY(5px); z-index: 2; }
        .card:nth-child(3) { transform: rotate(0deg) translateY(0px); z-index: 3; }
        .card:nth-child(4) { transform: rotate(5deg) translateY(5px); z-index: 2; }
        .card:nth-child(5) { transform: rotate(10deg) translateY(10px); z-index: 1; }
        .card-stack:hover .card:nth-child(1) { transform: rotate(-20deg) translateY(20px) translateX(-20px); }
        .card-stack:hover .card:nth-child(2) { transform: rotate(-10deg) translateY(10px) translateX(-10px); }
        .card-stack:hover .card:nth-child(3) { transform: translateY(-10px) scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(127, 19, 236, 0.4); }
        .card-stack:hover .card:nth-child(4) { transform: rotate(10deg) translateY(10px) translateX(10px); }
        .card-stack:hover .card:nth-child(5) { transform: rotate(20deg) translateY(20px) translateX(20px); }
        .card-pattern {
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        .word-keep-all {
            word-break: keep-all;
        }
    </style>
  </head>
<body>
    <div id="root" style="min-height:100vh; display:flex; align-items:center; justify-content:center; color:#111; font-family: 'Plus Jakarta Sans','Noto Sans KR',sans-serif; background:#f7f6f8;">
        <div style="text-align:center; max-width:420px; padding:24px;">
            <div style="font-weight:800; font-size:20px; margin-bottom:8px;">Life Position</div>
            <div style="color:#555; font-size:14px;">화면을 준비하고 있어요...</div>
        </div>
    </div>
    <noscript>
        <div style="padding:16px; color:#111; font-family: 'Plus Jakarta Sans','Noto Sans KR',sans-serif;">
            JavaScript가 비활성화되어 있어 화면을 표시할 수 없습니다.
        </div>
    </noscript>

    <script type="text/babel" data-presets="env,react">
        try {
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;
        const { HashRouter, Routes, Route, Link, useNavigate, useLocation } = ReactRouterDOM;

        // --- Components ---
        const APP_OUTER_CLASS = 'bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-[100dvh] h-[100dvh] flex justify-center overflow-hidden w-full';
        const APP_FRAME_CLASS = 'relative w-full max-w-[430px] min-h-[100dvh] h-[100dvh] max-h-[100dvh] bg-background-light dark:bg-background-dark flex flex-col overflow-hidden shadow-2xl';
        const AppScreen = ({ children, outerClassName = '', frameClassName = '' }) => (
            <div className={`${APP_OUTER_CLASS} ${outerClassName}`.trim()}>
                <div className={`${APP_FRAME_CLASS} ${frameClassName}`.trim()}>
                    {children}
                </div>
            </div>
        );

        // 1. Landing Screen
        const LandingScreen = () => {
            const navigate = useNavigate();
            return (
                <AppScreen frameClassName="text-slate-900 dark:text-slate-100">
                    <nav className="flex items-center justify-between p-6 z-10 relative">
                        <button className="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                            <span className="material-symbols-outlined text-slate-900 dark:text-slate-100" style={{ fontSize: '28px' }}>menu</span>
                        </button>
                        <div className="flex items-center gap-1">
                            <span className="text-xs font-bold tracking-widest uppercase text-slate-400 dark:text-slate-500">Life Position</span>
                        </div>
                        <button className="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                            <span className="material-symbols-outlined text-slate-900 dark:text-slate-100" style={{ fontSize: '28px' }}>account_circle</span>
                        </button>
                    </nav>

                    <main className="flex-1 flex flex-col items-center justify-center relative w-full max-w-[430px] mx-auto px-6 pb-24">
                        <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 bg-primary/20 rounded-full blur-[100px] pointer-events-none"></div>
                        <div className="relative w-full aspect-square max-w-[320px] flex items-center justify-center mb-8 animate-float">
                            <div className="absolute inset-0 border border-primary/10 rounded-full scale-110 animate-pulse-slow"></div>
                            <div className="absolute inset-0 border border-primary/5 rounded-full scale-125"></div>
                            <div className="relative w-full h-full rounded-3xl overflow-hidden shadow-2xl shadow-primary/20" style={{ background: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent), linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)' }}>
                                <img alt="Abstract floating 3D crystal prism purple gradient" className="w-full h-full object-cover mix-blend-overlay opacity-80" data-alt="Futuristic 3D floating crystal prism representing data analysis engine" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDMJM7G3hnXsTkJCuVrttKtDEoGR48Jg7_qyaRJwDspjOjOnysKw9RtUHsEt_6z-cglMtJdr1Fr5qjQ6PL-z5ptF0U8mThf7s9_n2pHREvaPB0KCcEBO7yHMj1RLF41Tm-_lg5FRxrlhix793nOTWF4FvTQIvIC5EpYkrc_owvyyed9VdHzen29lg8yTDsCMH45xnTlBDMG0mP8uPYevr3gKFHrn2RFNQX0dPkPaHH9ujH8tPg9HZZuLKWUXuL3-YdJuFET3-hmgg" />
                                <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-tr from-transparent via-white/30 to-transparent opacity-50"></div>
                            </div>
                        </div>
                        <div className="text-center space-y-3 z-10 relative">
                            <h1 className="text-[40px] font-black leading-tight tracking-tight text-slate-900 dark:text-white">
                                <span className="text-gradient">인생 포지션</span>
                            </h1>
                            <p className="text-base font-medium text-slate-500 dark:text-slate-400 keep-all">
                                질문부터 사주, 타로까지 이어지는<br />개인화 분석을 시작해보세요
                            </p>
                        </div>
                    </main>

                    <footer className="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-background-light via-background-light/90 to-transparent dark:from-background-dark dark:via-background-dark/90 pb-8 pt-12 z-20">
                        <div className="max-w-[430px] mx-auto flex flex-col gap-4">
                            <button 
                                onClick={() => navigate('/analysis')}
                                className="w-full h-14 bg-primary hover:bg-primary-light active:scale-[0.98] transition-all duration-200 text-white rounded-full font-bold text-lg shadow-lg shadow-primary/30 flex items-center justify-center gap-2 group"
                            >
                                <span>질문(설문) 시작하기</span>
                                <span className="material-symbols-outlined transition-transform group-hover:translate-x-1" style={{ fontSize: '20px' }}>arrow_forward</span>
                            </button>
                            <button className="w-full py-2 text-sm font-medium text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary-light transition-colors flex items-center justify-center gap-1">
                                <span className="material-symbols-outlined" style={{ fontSize: '18px' }}>history</span>
                                이전 결과 확인
                            </button>
                        </div>
                    </footer>
                </AppScreen>
            );
        };

        // 2. Birth Input Screen
        const BirthInputScreen = () => {
            const navigate = useNavigate();
            const location = useLocation();
            const psychVector = location.state?.psychVector || null;
            const answers = location.state?.answers || null;
            const [calendarType, setCalendarType] = useState('solar');
            const [birthDate, setBirthDate] = useState('1997-09-01');
            const [hour, setHour] = useState('10');
            const [minute, setMinute] = useState('30');
            const [isUnknownTime, setIsUnknownTime] = useState(false);

            const formattedDate = birthDate
                ? birthDate.replace(/-/g, '. ')
                : '날짜 선택';
            const formattedTime = isUnknownTime ? '시간 모름' : `${hour}:${minute}`;

            return (
                <AppScreen frameClassName="text-slate-900 dark:text-slate-100">
                        <header className="flex items-center px-4 py-4 sticky top-0 z-20 bg-background-light dark:bg-background-dark">
                            <button 
                                onClick={() => navigate(-1)}
                                className="w-11 h-11 flex items-center justify-center rounded-full hover:bg-primary/10 transition-colors text-slate-900 dark:text-slate-100"
                            >
                                <span className="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                            </button>
                            <h1 className="flex-1 text-center text-xl font-bold tracking-tight">출생 정보 입력</h1>
                            <div className="w-11"></div>
                        </header>
                        <main className="flex-1 overflow-y-auto pb-32 px-6 no-scrollbar">
                            <div className="mt-1 mb-4">
                                <div className="flex justify-between items-end px-1 mb-2">
                                    <span className="text-[11px] font-semibold text-primary/80 uppercase tracking-wider">사주 단계</span>
                                    <span className="text-sm font-bold text-primary">2 <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ 4</span></span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full" style={{ width: '50%' }}></div>
                                </div>
                                <p className="mt-2 text-[11px] text-slate-500 dark:text-slate-400">예상 소요 시간: 1분</p>
                            </div>
                            <div className="mt-4 mb-8">
                                <h2 className="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-3 leading-tight">
                                    언제 <br /><span className="text-primary">태어나셨나요?</span>
                                </h2>
                                <p className="text-slate-500 dark:text-slate-400 text-sm leading-relaxed flex items-start gap-2">
                                    <span className="material-symbols-outlined text-primary text-[18px] mt-0.5">lock</span>
                                    <span>정확한 사주 분석을 위해 생년월일시가 필요합니다. 토큰 기반 접근과 HTTPS로 안전하게 처리됩니다.</span>
                                </p>
                            </div>
                            <div className="bg-surface-light dark:bg-surface-dark p-1 rounded-xl flex shadow-sm border border-slate-100 dark:border-slate-800 mb-8 h-[52px]">
                                <button
                                    type="button"
                                    onClick={() => setCalendarType('solar')}
                                    className={`flex-1 rounded-lg text-sm font-bold transition-all flex items-center justify-center ${
                                        calendarType === 'solar'
                                            ? 'bg-primary text-white shadow-md'
                                            : 'text-slate-500 dark:text-slate-400 hover:text-primary'
                                    }`}
                                >
                                    양력
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setCalendarType('lunar')}
                                    className={`flex-1 rounded-lg text-sm font-bold transition-all flex items-center justify-center ${
                                        calendarType === 'lunar'
                                            ? 'bg-primary text-white shadow-md'
                                            : 'text-slate-500 dark:text-slate-400 hover:text-primary'
                                    }`}
                                >
                                    음력
                                </button>
                            </div>
                            <section className="mb-10">
                                <div className="flex items-center justify-between mb-3 px-1">
                                    <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">생년월일</h2>
                                </div>
                                <div className="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 p-4 flex items-center justify-between shadow-sm active:border-primary active:ring-1 active:ring-primary transition-all group min-h-[72px]">
                                    <div className="flex items-center gap-4">
                                        <div className="bg-primary/10 w-12 h-12 flex items-center justify-center rounded-full text-primary">
                                            <span className="material-symbols-outlined text-[24px]">calendar_today</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider mb-0.5">선택된 날짜</span>
                                            <span className="text-xl font-bold text-slate-900 dark:text-white">{formattedDate}</span>
                                        </div>
                                    </div>
                                    <span className="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors text-[24px]">
                                        calendar_month
                                    </span>
                                </div>
                                <div className="mt-4">
                                    <input
                                        type="date"
                                        className="h-14 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-4 text-base text-slate-900 dark:text-white font-semibold"
                                        value={birthDate}
                                        onChange={(event) => setBirthDate(event.target.value)}
                                    />
                                </div>
                                <p className="mt-2 text-xs text-slate-400 dark:text-slate-500 px-2 leading-relaxed">
                                    * 수집된 생년월일은 사주 분석 목적으로만 사용되며, 외부에 공개되지 않습니다.
                                </p>
                            </section>
                            <section className="mb-8 relative">
                                <div className="flex items-center justify-between mb-3 px-1">
                                    <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">태어난 시간</h2>
                                    <label className="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                                        <input
                                            className="accent-primary w-4 h-4"
                                            type="checkbox"
                                            checked={isUnknownTime}
                                            onChange={(event) => setIsUnknownTime(event.target.checked)}
                                        />
                                        모름
                                    </label>
                                </div>
                                <div className="relative bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm p-5">
                                    <div className="flex items-center gap-4 mb-5">
                                        <div className="bg-primary/10 w-12 h-12 flex items-center justify-center rounded-full text-primary">
                                            <span className="material-symbols-outlined text-[24px]">schedule</span>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500 dark:text-slate-400">선택된 시간</p>
                                            <p className="text-2xl font-bold tracking-wide text-slate-900 dark:text-white">{formattedTime}</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="flex flex-col gap-1">
                                            <label className="text-sm text-slate-500 dark:text-slate-400">시</label>
                                            <select
                                                className="h-12 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark text-base text-slate-900 dark:text-white font-semibold"
                                                value={hour}
                                                onChange={(event) => setHour(event.target.value)}
                                                disabled={isUnknownTime}
                                            >
                                                {Array.from({ length: 24 }, (_, idx) => String(idx).padStart(2, '0')).map((value) => (
                                                    <option key={value} value={value}>{value}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <label className="text-sm text-slate-500 dark:text-slate-400">분</label>
                                            <select
                                                className="h-12 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark text-base text-slate-900 dark:text-white font-semibold"
                                                value={minute}
                                                onChange={(event) => setMinute(event.target.value)}
                                                disabled={isUnknownTime}
                                            >
                                                {Array.from({ length: 60 }, (_, idx) => String(idx).padStart(2, '0')).map((value) => (
                                                    <option key={value} value={value}>{value}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <p className="mt-2 text-xs text-slate-400 dark:text-slate-500 px-2 leading-relaxed">
                                    * 정확한 시(時)를 모를 경우 '모름'을 체크해주세요. 평균적인 운세로 분석됩니다.
                                </p>
                                <div className="mt-8">
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">성별</h2>
                                    </div>
                                    <div className="flex gap-4">
                                        <label className="cursor-pointer flex-1">
                                            <input defaultChecked className="peer sr-only" name="gender" type="radio" />
                                            <div className="flex items-center justify-center h-14 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-surface-dark peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white transition-all shadow-sm gap-2">
                                                <span className="material-symbols-outlined text-[20px]">female</span>
                                                <span className="text-base font-bold">여성</span>
                                            </div>
                                        </label>
                                        <label className="cursor-pointer flex-1">
                                            <input className="peer sr-only" name="gender" type="radio" />
                                            <div className="flex items-center justify-center h-14 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-surface-dark peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white transition-all shadow-sm gap-2">
                                                <span className="material-symbols-outlined text-[20px]">male</span>
                                                <span className="text-base font-bold">남성</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </section>
                        </main>
                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark dark:via-background-dark pt-12">
                            <button 
                                onClick={() => navigate('/tarot', {
                                    state: {
                                        birthData: {
                                            calendarType,
                                            date: birthDate,
                                            hour: isUnknownTime ? null : hour,
                                            minute: isUnknownTime ? null : minute,
                                            unknownTime: isUnknownTime,
                                            psychVector,
                                            answers,
                                        },
                                    },
                                })}
                                className="w-full h-14 bg-primary hover:bg-violet-700 text-white text-lg font-bold rounded-2xl shadow-lg shadow-primary/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2 group"
                            >
                                <span>사주 분석 완료</span>
                                <span className="material-symbols-outlined group-hover:translate-x-1 transition-transform text-[24px]">arrow_forward</span>
                            </button>
                            <p className="mt-3 text-[11px] text-center text-slate-400 dark:text-slate-500 font-medium">
                                개인정보는 서비스 이용 후 즉시 파기됩니다.
                            </p>
                        </div>
                </AppScreen>
            );
        };

        const SCORE = {
            A: { action: 3, emotion: -1, social: 1, stability: -2 },
            B: { action: 1, emotion: 1, social: 0, stability: 1 },
            C: { action: -1, emotion: 2, social: -1, stability: 2 },
            D: { action: -3, emotion: 3, social: -2, stability: 3 },
        };

        const QUESTIONS = [
            {
                axis: 'action',
                text: '해야 할 일이 몰리면?',
                options: {
                    A: '일단 하나라도 바로 처리한다',
                    B: '우선순위를 정하고 순서대로 한다',
                    C: '분석하다 시간이 간다',
                    D: '잠깐 피하고 싶어진다',
                },
            },
            {
                axis: 'action',
                text: '새로운 제안이 들어오면?',
                options: {
                    A: '바로 “해보자”가 나온다',
                    B: '조건/일정을 먼저 확인한다',
                    C: '리스크를 먼저 따져본다',
                    D: '누가 같이 해주면 한다',
                },
            },
            {
                axis: 'action',
                text: '결정을 내려야 할 때',
                options: {
                    A: '감으로 빨리 고른다',
                    B: '비교 후 선택한다',
                    C: '계속 고민한다',
                    D: '남이 정해주면 편하다',
                },
            },
            {
                axis: 'action',
                text: '계획이 틀어졌을 때',
                options: {
                    A: '즉시 대안을 실행한다',
                    B: '재정리 후 조정한다',
                    C: '멈추고 원인부터 본다',
                    D: '일단 상황이 지나가길 기다린다',
                },
            },
            {
                axis: 'emotion',
                text: '비판을 들었을 때',
                options: {
                    A: '“오케이” 하고 바로 바꾼다',
                    B: '받아들이되 감정은 정리한다',
                    C: '하루 종일 신경 쓰인다',
                    D: '관계/상황을 피하고 싶다',
                },
            },
            {
                axis: 'emotion',
                text: '중요한 일이 가까워질수록',
                options: {
                    A: '오히려 에너지가 난다',
                    B: '루틴을 잡고 차분히 준비한다',
                    C: '불안이 올라온다',
                    D: '회피/미루기가 생긴다',
                },
            },
            {
                axis: 'emotion',
                text: '감정 표현 방식',
                options: {
                    A: '바로 말한다',
                    B: '정리해서 말한다',
                    C: '속으로 곱씹는다',
                    D: '말 안 하고 거리를 둔다',
                },
            },
            {
                axis: 'emotion',
                text: '후회가 생기면',
                options: {
                    A: '다음 행동으로 덮는다',
                    B: '교훈으로 정리한다',
                    C: '계속 되새긴다',
                    D: '생각을 끊으려고 회피한다',
                },
            },
            {
                axis: 'social',
                text: '고민이 생기면',
                options: {
                    A: '혼자 결론 내린다',
                    B: '한 명에게만 공유한다',
                    C: '여러 사람 의견을 듣는다',
                    D: '누가 이끌어주길 바란다',
                },
            },
            {
                axis: 'social',
                text: '연락 스타일',
                options: {
                    A: '필요할 때만 깔끔하게',
                    B: '주기적으로 안부',
                    C: '상대 반응에 따라 흔들림',
                    D: '먼저 연락하기 어렵다',
                },
            },
            {
                axis: 'social',
                text: '모임에서 내 포지션',
                options: {
                    A: '분위기 주도',
                    B: '필요한 말만 정리',
                    C: '관찰/청취 중심',
                    D: '피곤해서 빠지고 싶다',
                },
            },
            {
                axis: 'social',
                text: '갈등이 생기면',
                options: {
                    A: '바로 대화로 푼다',
                    B: '타이밍을 보고 조정한다',
                    C: '분석하다 더 어렵다',
                    D: '멀어지며 정리한다',
                },
            },
            {
                axis: 'stability',
                text: '큰 변화가 오면',
                options: {
                    A: '기회라고 느낀다',
                    B: '준비해서 적응한다',
                    C: '불안해서 계획을 더 세운다',
                    D: '변화 자체를 피하고 싶다',
                },
            },
            {
                axis: 'stability',
                text: '실패했을 때',
                options: {
                    A: '재도전한다',
                    B: '수정해서 다시 한다',
                    C: '의미를 분석하다 멈춘다',
                    D: '그 일은 손 떼고 싶다',
                },
            },
            {
                axis: 'stability',
                text: '불확실한 상황에서',
                options: {
                    A: '들어가서 배운다',
                    B: '정보 수집 후 들어간다',
                    C: '계속 확신이 안 선다',
                    D: '결정 자체가 부담이다',
                },
            },
            {
                axis: 'stability',
                text: '책임을 져야 할 때',
                options: {
                    A: '내가 맡는다',
                    B: '역할을 나눈다',
                    C: '부담이 커진다',
                    D: '피할 수 있으면 피한다',
                },
            },
        ];

        // 3. Analysis (Quiz) Screen
        const AnalysisScreen = () => {
            const navigate = useNavigate();
            const [currentIndex, setCurrentIndex] = useState(0);
            const [answers, setAnswers] = useState([]);
            const [scores, setScores] = useState({
                action: 0,
                emotion: 0,
                social: 0,
                stability: 0,
            });
            const currentQuestion = QUESTIONS[currentIndex];
            const progress = Math.round(((currentIndex + 1) / QUESTIONS.length) * 100);

            const applyScore = (base, delta) => ({
                action: base.action + delta.action,
                emotion: base.emotion + delta.emotion,
                social: base.social + delta.social,
                stability: base.stability + delta.stability,
            });

            const handleSelect = (choice) => {
                const nextScores = applyScore(scores, SCORE[choice]);
                const nextAnswers = [...answers, choice];
                const isLast = currentIndex + 1 >= QUESTIONS.length;

                setScores(nextScores);
                setAnswers(nextAnswers);

                if (isLast) {
                    navigate('/birth', { state: { psychVector: nextScores, answers: nextAnswers } });
                    return;
                }

                setCurrentIndex((prev) => prev + 1);
            };

            return (
                <AppScreen outerClassName="font-sans antialiased selection:bg-primary selection:text-white" frameClassName="text-text-main dark:text-slate-100">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none" data-alt="Soft purple glow decorative element"></div>
                        <div className="absolute bottom-0 left-0 w-80 h-80 bg-primary/5 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none" data-alt="Soft purple glow decorative element"></div>
                        <header className="relative z-10 pt-6 px-6 pb-4">
                            <div className="flex items-center justify-between mb-6">
                                <button 
                                    onClick={() => navigate('/')}
                                    className="p-2 -ml-2 text-slate-500 hover:text-primary transition-colors duration-200 rounded-full hover:bg-primary/5 dark:text-slate-400 dark:hover:text-primary"
                                >
                                    <span className="material-symbols-outlined text-[28px]">close</span>
                                </button>
                                <div className="flex flex-col items-center">
                                    <span className="text-xs font-bold tracking-widest text-primary uppercase opacity-90">인생 포지션</span>
                                </div>
                                <div className="w-10"></div>
                            </div>
                            <div className="flex flex-col gap-2.5">
                                <div className="flex justify-between items-end px-1">
                                    <span className="text-xs font-semibold text-primary/70 dark:text-primary/50 uppercase tracking-wider">질문 단계</span>
                                    <span className="text-sm font-bold text-primary">
                                        {currentIndex + 1}{' '}
                                        <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ {QUESTIONS.length}</span>
                                    </span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(127,19,236,0.3)]" style={{ width: `${progress}%` }}></div>
                                </div>
                                <div className="flex items-center justify-between text-[11px] text-slate-500 dark:text-slate-400 px-1">
                                    <span>질문</span>
                                    <span>사주</span>
                                    <span>타로</span>
                                    <span>결과</span>
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 flex flex-col px-6 relative z-10 overflow-y-auto">
                            <section className="py-10 flex flex-col items-center justify-center min-h-[200px]">
                                <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-primary/10 mb-6 text-primary shadow-sm">
                                    <span className="material-symbols-outlined text-2xl">psychology_alt</span>
                                </div>
                                <h1 className="text-2xl md:text-[26px] font-bold text-slate-900 dark:text-white text-center leading-snug tracking-tight word-keep-all w-full max-w-[320px] line-clamp-2">
                                    {currentQuestion.text}
                                </h1>
                                <p className="mt-3 text-xs text-slate-500 dark:text-slate-400">설문 완료 후 사주 분석 단계로 이동합니다.</p>
                            </section>
                            <section className="flex-1 flex flex-col items-stretch gap-3.5 pb-10 w-full">
                                {Object.entries(currentQuestion.options).map(([key, label]) => (
                                    <label key={key} className="group relative cursor-pointer block touch-manipulation w-full self-stretch">
                                        <input
                                            onChange={() => handleSelect(key)}
                                            className="peer sr-only"
                                            name={`question_${currentIndex}`}
                                            type="radio"
                                            value={key}
                                        />
                                        <div className="card-ring w-full min-h-[88px] flex items-center gap-4 p-5 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark transition-all duration-200 hover:border-primary/40 dark:hover:border-primary/40 active:scale-[0.99] shadow-sm">
                                            <div className="flex-1 py-1">
                                                <p className="text-[16px] font-medium leading-[1.6] text-slate-700 dark:text-slate-200 group-hover:text-primary dark:group-hover:text-primary transition-colors word-keep-all line-clamp-2">
                                                    {label}
                                                </p>
                                            </div>
                                            <div className="radio-indicator relative shrink-0 w-6 h-6 rounded-full border-2 border-slate-300 dark:border-slate-500 transition-colors duration-200"></div>
                                        </div>
                                    </label>
                                ))}
                            </section>
                        </main>
                        <footer className="p-5 pb-10 relative z-10 flex justify-center">
                            <button 
                                onClick={() => navigate(-1)}
                                className="group flex items-center gap-2 px-6 py-3 rounded-full text-slate-500 hover:text-primary hover:bg-primary/5 transition-all dark:text-slate-400 dark:hover:text-primary"
                            >
                                <span className="material-symbols-outlined text-lg transition-transform group-hover:-translate-x-1">arrow_back</span>
                                <span className="text-[15px] font-bold tracking-wide">이전 화면</span>
                            </button>
                        </footer>
                </AppScreen>
            );
        };

        // 4. Tarot Selection Screen
        const BACK_THEMES = {
            indigo: 'linear-gradient(135deg, #1f122e 0%, #7f13ec 100%)',
            amber: 'linear-gradient(135deg, #2b1606 0%, #ff8a00 45%, #ff2e63 100%)',
            teal: 'linear-gradient(135deg, #061a2b 0%, #00c2ff 50%, #00f5d4 100%)',
            violet: 'linear-gradient(135deg, #120b22 0%, #7f13ec 100%)',
            crimson: 'linear-gradient(135deg, #24070d 0%, #ff3b6b 100%)',
            rose: 'linear-gradient(135deg, #1f0a1a 0%, #ff4fd8 100%)',
            slate: 'linear-gradient(135deg, #0b1220 0%, #64748b 100%)',
            emerald: 'linear-gradient(135deg, #071c14 0%, #10b981 100%)',
            bronze: 'linear-gradient(135deg, #1f140a 0%, #d97706 100%)',
            red: 'linear-gradient(135deg, #20060a 0%, #ef4444 100%)',
            blue: 'linear-gradient(135deg, #071227 0%, #3b82f6 100%)',
            gray: 'linear-gradient(135deg, #111827 0%, #6b7280 100%)',
            mint: 'linear-gradient(135deg, #06221c 0%, #34d399 100%)',
        };

        const FLOW_CARDS = [
            {
                deck: 'flow',
                id: 'moon',
                label: '월',
                code: 'Moon 03',
                image: '/assets/images/tarot/traditional_moon.svg',
                backTheme: 'indigo',
                symbol: 'nights_stay',
                stateTag: 'recovery',
                region: 'coast',
                meaning: {
                    archetype: '무의식/직관/감정의 파도/불확실성 속 탐색',
                    korea: '마음이 잔물결처럼 흔들릴수록, 숨 고르고 결을 정리해야 하는 날',
                    strength: ['분위기 센스', '회복 탄력', '관계의 미묘한 신호 포착'],
                    caution: ['확답 회피', '과해석', '컨디션 기복'],
                    advice: ['속도를 늦추고 루틴 회복', '감정을 한 줄로 정리 후 말하기'],
                },
            },
            {
                deck: 'flow',
                id: 'sun',
                label: '태양',
                code: 'Sun 07',
                image: '/assets/images/tarot/traditional_sun.svg',
                backTheme: 'amber',
                symbol: 'wb_sunny',
                stateTag: 'push',
                region: 'city',
                meaning: {
                    archetype: '성공/가시성/명료함/확장/자신감',
                    korea: '오늘은 빛나는 자리로 나가야 복이 트인다. 숨기면 손해.',
                    strength: ['결단력', '발표/세일즈', '에너지 확장'],
                    caution: ['과속', '과신', '말이 커지는 실수'],
                    advice: ['결정은 오늘 안에 확정', '성과 1개를 공개(공유/발표)'],
                },
            },
            {
                deck: 'flow',
                id: 'star',
                label: '별',
                code: 'Star 11',
                image: '/assets/images/tarot/traditional_star.svg',
                backTheme: 'teal',
                symbol: 'auto_awesome',
                stateTag: 'transition',
                region: 'mountain',
                meaning: {
                    archetype: '희망/치유/리셋/재정렬/새 방향',
                    korea: '산길은 돌아가도 안전하다. 정리하고 다시 가는 게 이득인 날.',
                    strength: ['장기 관점', '재정렬 감각', '리셋 능력'],
                    caution: ['실행이 늦어짐', '큰 그림만 보고 방치'],
                    advice: ['버릴 것 3개 정리(업무/관계/습관)', '새 루틴 1개를 아주 작게 시작'],
                },
            },
        ];

        const CORE_CARDS = [
            {
                deck: 'core',
                id: 'strategist',
                label: '책사',
                code: 'Core 01',
                symbol: 'account_tree',
                backTheme: 'violet',
                meaning: {
                    archetype: '설계/판단/구조화(마법사·정의 계열)',
                    korea: '판을 읽고 각이 나오면 한 번에 정리한다.',
                    strength: ['프레임 설계', '정보 판단', '전략적 의사결정'],
                    caution: ['공감 부족', '통제 성향'],
                    advice: ['결정 근거를 3줄로 요약', '상대 감정 확인 질문 1개 추가'],
                },
            },
            {
                deck: 'core',
                id: 'pioneer',
                label: '선봉',
                code: 'Core 02',
                symbol: 'flag',
                backTheme: 'crimson',
                meaning: {
                    archetype: '돌파/개척(전차·힘 계열)',
                    korea: '말보다 행동. 일단 뛰고 길을 만든다.',
                    strength: ['추진력', '개척', '리스크 감수'],
                    caution: ['디테일 누락', '번아웃'],
                    advice: ['오늘은 완주보다 착수', '체력 보호(중간 휴식 고정)'],
                },
            },
            {
                deck: 'core',
                id: 'creator',
                label: '예인',
                code: 'Core 03',
                symbol: 'palette',
                backTheme: 'rose',
                meaning: {
                    archetype: '창조/표현(여황제·별 계열)',
                    korea: '감정과 장면을 콘텐츠로 바꾼다.',
                    strength: ['창의', '브랜딩', '표현력'],
                    caution: ['기복', '루틴 약함'],
                    advice: ['1일 1개 산출물', '감정은 소재로만 쓰기'],
                },
            },
            {
                deck: 'core',
                id: 'observer',
                label: '학자',
                code: 'Core 04',
                symbol: 'science',
                backTheme: 'slate',
                meaning: {
                    archetype: '탐구/검증(은둔자·여사제 계열)',
                    korea: '바로 움직이진 않지만 정답을 찾는다.',
                    strength: ['분석', '리서치', '리스크 제어'],
                    caution: ['실행 지연', '과분석'],
                    advice: ['오늘은 결정 기준만 확정', '80% 확신이면 착수'],
                },
            },
            {
                deck: 'core',
                id: 'harmonizer',
                label: '외교관',
                code: 'Core 05',
                symbol: 'handshake',
                backTheme: 'emerald',
                meaning: {
                    archetype: '조화/관계(절제·연인 계열)',
                    korea: '분위기를 정리해 갈등을 없던 일로 만든다.',
                    strength: ['협업', '조율', '신뢰 형성'],
                    caution: ['눈치 과다', '자기 욕구 억눌림'],
                    advice: ['오늘은 거절을 1번 연습', '역할 경계선 문장 준비'],
                },
            },
            {
                deck: 'core',
                id: 'artisan',
                label: '장인',
                code: 'Core 06',
                symbol: 'build',
                backTheme: 'bronze',
                meaning: {
                    archetype: '현실/축적(황제·펜타클 계열)',
                    korea: '꾸준히 쌓아 결과물로 증명한다.',
                    strength: ['지속', '품질', '반복 개선'],
                    caution: ['변화 둔감', '완벽주의'],
                    advice: ['오늘은 70% 완성 후 배포', '개선 리스트 3개만 남기기'],
                },
            },
        ];

        const PATTERN_CARDS = [
            {
                deck: 'pattern',
                id: 'rush',
                label: '돌파',
                code: 'Pattern 01',
                symbol: 'bolt',
                backTheme: 'red',
                meaning: {
                    archetype: '직진/결단(기사 계열)',
                    korea: '각 나오면 바로 박는다.',
                    strength: ['결단', '추진'],
                    caution: ['과속/실수'],
                    advice: ['착수 전 체크리스트 3개', '하루 1번 속도 조절'],
                },
            },
            {
                deck: 'pattern',
                id: 'plan',
                label: '설계',
                code: 'Pattern 02',
                symbol: 'route',
                backTheme: 'blue',
                meaning: {
                    archetype: '체계/질서(정의·교황 계열)',
                    korea: '순서와 규칙이 있어야 마음이 편하다.',
                    strength: ['안정', '재현성'],
                    caution: ['유연성 부족'],
                    advice: ['예외 규칙 1개 허용', '계획은 80%만 고정'],
                },
            },
            {
                deck: 'pattern',
                id: 'avoid',
                label: '은둔',
                code: 'Pattern 03',
                symbol: 'shield_moon',
                backTheme: 'gray',
                meaning: {
                    archetype: '거리두기/보호(은둔자·달 계열)',
                    korea: '잠깐 숨는 게 생존 전략이 되는 날이 있다.',
                    strength: ['자기 보호', '감정 조절'],
                    caution: ['미루기/단절'],
                    advice: ['회피 대신 시간 예약', '연락은 짧게라도 유지'],
                },
            },
            {
                deck: 'pattern',
                id: 'rely',
                label: '조력',
                code: 'Pattern 04',
                symbol: 'support_agent',
                backTheme: 'mint',
                meaning: {
                    archetype: '연결/멘토(교황·연인 계열)',
                    korea: '혼자보다 같이가 잘 되는 타입',
                    strength: ['협업', '피드백 흡수'],
                    caution: ['타인 기준 과의존'],
                    advice: ['결정 기준 1개는 스스로', '조언은 2명까지만'],
                },
            },
        ];

        const DECK_ORDER = ['core', 'pattern', 'flow'];

        const deckCards = (deck) => {
            if (deck === 'core') return CORE_CARDS;
            if (deck === 'pattern') return PATTERN_CARDS;
            return FLOW_CARDS;
        };

        const deckSpreadCount = (deck) => {
            if (deck === 'core') return 5;
            if (deck === 'pattern') return 4;
            return 3;
        };

        const sampleCards = (cards, count) => {
            const pool = [...cards];
            for (let i = pool.length - 1; i > 0; i -= 1) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            return pool.slice(0, Math.min(count, pool.length));
        };

        const findCardById = (id) => [...FLOW_CARDS, ...CORE_CARDS, ...PATTERN_CARDS].find((card) => card.id === id);

        const CardFront = ({ card }) => (
            <div className="absolute inset-0 rounded-2xl overflow-hidden">
                {card.image ? (
                    <div className="absolute inset-0 bg-cover bg-center opacity-90" style={{ backgroundImage: `url('${card.image}')` }} />
                ) : (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/10">
                        <span className="material-symbols-outlined text-white text-[64px] opacity-90">{card.symbol}</span>
                    </div>
                )}
                <div className="absolute inset-0 bg-gradient-to-b from-black/10 via-transparent to-black/60"></div>
                <div className="absolute top-4 left-4 px-3 py-1 rounded-full bg-white/10 backdrop-blur border border-white/15">
                    <span className="text-[11px] font-bold text-white tracking-widest uppercase">{card.code}</span>
                </div>
                <div className="absolute bottom-5 left-0 right-0 text-center">
                    <div className="text-white text-xl font-black">{card.label}</div>
                    <div className="text-white/80 text-[11px] font-semibold mt-1 px-4">
                        {card.meaning?.korea}
                    </div>
                </div>
            </div>
        );

        const CardBack = ({ card }) => (
            <div
                className="absolute inset-0 rounded-2xl border border-white/10"
                style={{ background: BACK_THEMES[card.backTheme] || BACK_THEMES.indigo }}
            >
                <div
                    className="absolute inset-0 opacity-10"
                    style={{
                        backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)',
                        backgroundSize: '20px 20px',
                    }}
                ></div>
                <div className="absolute inset-0 flex items-center justify-center">
                    <div className="w-16 h-16 rounded-full border border-white/20 flex items-center justify-center bg-white/5 backdrop-blur-sm">
                        <span className="material-symbols-outlined text-white/80 text-3xl">{card.symbol}</span>
                    </div>
                </div>
            </div>
        );

        const FlipCard = ({ card, onPick, disabled, revealed }) => (
            <button
                disabled={disabled}
                onClick={() => onPick(card)}
                className={`relative w-[140px] h-[210px] sm:w-[150px] sm:h-[225px] rounded-2xl transition-transform active:scale-[0.98] ${
                    disabled ? 'opacity-70' : 'hover:-translate-y-1'
                }`}
                style={{ perspective: 1000 }}
            >
                <div
                    className="absolute inset-0 transition-transform duration-700"
                    style={{
                        transformStyle: 'preserve-3d',
                        transform: revealed ? 'rotateY(180deg)' : 'rotateY(0deg)',
                    }}
                >
                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden' }}>
                        <CardBack card={card} />
                    </div>
                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                        <CardFront card={card} />
                    </div>
                </div>
            </button>
        );

        const CardDetailModal = ({ card, onClose }) => {
            const [flipped, setFlipped] = useState(false);

            useEffect(() => {
                if (!card) return;
                setFlipped(false);
                const timer = setTimeout(() => setFlipped(true), 60);
                return () => clearTimeout(timer);
            }, [card]);

            if (!card) return null;
            return (
                <div className="fixed inset-0 z-[999] flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-[92%] max-w-md rounded-3xl bg-background-light dark:bg-background-dark border border-slate-200 dark:border-slate-700 shadow-2xl p-6">
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 w-9 h-9 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center"
                        >
                            <span className="material-symbols-outlined text-[22px]">close</span>
                        </button>
                        <div className="flex items-center gap-4 mb-4">
                            <div className="w-16 h-20 shrink-0" style={{ perspective: 600 }}>
                                <div
                                    className="relative w-full h-full rounded-xl overflow-hidden transition-transform duration-700"
                                    style={{ transformStyle: 'preserve-3d', transform: flipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                                >
                                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden' }}>
                                        <CardBack card={card} />
                                    </div>
                                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                                        <CardFront card={card} />
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="text-xs font-bold tracking-widest text-primary uppercase">{card.code}</div>
                                <h3 className="text-2xl font-black text-slate-900 dark:text-white">{card.label}</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{card.meaning?.archetype}</p>
                            </div>
                        </div>
                        <div className="space-y-4 text-sm text-slate-700 dark:text-slate-300">
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">한국 정서</div>
                                <p className="leading-relaxed">{card.meaning?.korea}</p>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">강점</div>
                                <p className="leading-relaxed">{card.meaning?.strength?.join(' · ')}</p>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">주의</div>
                                <p className="leading-relaxed">{card.meaning?.caution?.join(' · ')}</p>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">오늘 조언</div>
                                <p className="leading-relaxed">{card.meaning?.advice?.join(' / ')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TarotScreen = ({ pickedTarots, setPickedTarots }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const birthData = location.state?.birthData || null;
            const [step, setStep] = useState(0);
            const [phase, setPhase] = useState('idle');
            const [spread, setSpread] = useState([]);
            const [pickedThisStep, setPickedThisStep] = useState(null);
            const [detailCard, setDetailCard] = useState(null);

            const deck = DECK_ORDER[step];
            const totalSteps = DECK_ORDER.length;

            useEffect(() => {
                if (pickedTarots.length > 0) {
                    setPickedTarots([]);
                }
                setStep(0);
                setPhase('idle');
                setPickedThisStep(null);
            }, []);

            useEffect(() => {
                const cards = deckCards(deck);
                const count = deckSpreadCount(deck);
                setSpread(sampleCards(cards, count));
                setPhase('idle');
                setPickedThisStep(null);
            }, [deck]);

            const onPick = (card) => {
                if (phase !== 'idle') return;
                setPickedThisStep(card);
                setPhase('revealing');
                setPickedTarots((prev) => [...prev, { deck, id: card.id }]);
                setTimeout(() => setPhase('revealed'), 750);
            };

            const onNext = () => {
                if (step + 1 >= totalSteps) {
                    navigate('/result', { state: { birthData } });
                } else {
                    setStep((prev) => prev + 1);
                }
            };

            const titleMap = {
                core: { title: '정체성 카드', desc: '당신의 기본 역할(코어)을 고르세요.' },
                pattern: { title: '습관 카드', desc: '당신의 행동 방식(패턴)을 고르세요.' },
                flow: { title: '흐름 카드', desc: '오늘의 흐름을 닮은 한 장을 고르세요. (마지막 카드가 지역을 결정합니다)' },
            };
            const revealedTheme = BACK_THEMES[pickedThisStep?.backTheme] || BACK_THEMES.indigo;

            return (
                <AppScreen>
                        <header className="flex items-center justify-between p-4 pb-2">
                            <button
                                onClick={() => navigate(-1)}
                                className="flex size-10 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"
                            >
                                <span className="material-symbols-outlined text-[24px]">arrow_back</span>
                            </button>
                            <div className="text-center">
                                <div className="text-sm font-bold tracking-widest uppercase">타로 선택</div>
                                <div className="text-xs text-slate-500 dark:text-slate-400 font-medium">
                                    {step + 1} / {totalSteps}
                                </div>
                            </div>
                            <button
                                onClick={() => navigate('/')}
                                className="flex size-10 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"
                            >
                                <span className="material-symbols-outlined text-[24px]">close</span>
                            </button>
                        </header>

                        <div className="w-full px-6 py-2">
                            <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-primary rounded-full transition-all"
                                    style={{ width: `${((step + 1) / totalSteps) * 100}%` }}
                                ></div>
                            </div>
                        </div>

                        <div className="px-6 pt-2 pb-2">
                            <h1 className="text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                                {titleMap[deck].title}
                            </h1>
                            <p className="text-sm text-slate-600 dark:text-slate-300 mt-1 leading-relaxed break-keep">
                                {titleMap[deck].desc}
                            </p>
                        </div>

                        <main className="flex-1 px-6 pt-4 pb-28 flex flex-col">
                            <div className="flex-1 flex items-center justify-center">
                                <div className={`grid gap-3 ${spread.length <= 3 ? 'grid-cols-3' : 'grid-cols-2'} justify-items-center`}>
                                    {spread.map((card) => {
                                        const isSelected = pickedThisStep?.id === card.id;
                                        const disableOthers = phase !== 'idle' && !isSelected;
                                        return (
                                            <FlipCard
                                                key={card.id}
                                                card={card}
                                                onPick={onPick}
                                                disabled={disableOthers}
                                                revealed={isSelected && phase !== 'idle'}
                                            />
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="mt-6">
                                <div className="flex items-center justify-between px-1 mb-2">
                                    <div className="text-xs font-bold tracking-widest text-slate-500 dark:text-slate-400 uppercase">
                                        Picked
                                    </div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400">{pickedTarots.length} 장</div>
                                </div>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                    {pickedTarots.map((p, idx) => {
                                        const card = findCardById(p.id);
                                        if (!card) return null;
                                        return (
                                            <div
                                                key={`${p.deck}-${p.id}-${idx}`}
                                                className={`shrink-0 w-[64px] h-[92px] rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm ${
                                                    idx === pickedTarots.length - 1 ? 'ring-2 ring-primary/60' : ''
                                                }`}
                                                onClick={() => setDetailCard(card)}
                                            >
                                                {card.image ? (
                                                    <div className="w-full h-full bg-cover bg-center" style={{ backgroundImage: `url('${card.image}')` }}></div>
                                                ) : (
                                                    <div
                                                        className="w-full h-full flex items-center justify-center"
                                                        style={{ background: BACK_THEMES[card.backTheme] || BACK_THEMES.indigo }}
                                                    >
                                                        <span className="material-symbols-outlined text-white text-[28px]">{card.symbol}</span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </main>

                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95">
                            <button
                                disabled={phase !== 'revealed'}
                                onClick={onNext}
                                className={`w-full h-14 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                                    phase === 'revealed'
                                        ? 'text-white shadow-glow active:scale-[0.98]'
                                        : 'bg-slate-200 text-slate-500 dark:bg-slate-800 dark:text-slate-500'
                                }`}
                                style={phase === 'revealed' ? { background: revealedTheme } : undefined}
                            >
                                <span>{step + 1 >= totalSteps ? '결과 보기' : '다음 카드 뽑기'}</span>
                                <span className="material-symbols-outlined text-[24px]">arrow_forward</span>
                            </button>
                            <p className="mt-3 text-[11px] text-center text-slate-400 dark:text-slate-500 font-medium">
                                카드 선택은 성향 해석을 위한 상징적 단계입니다.
                            </p>
                        </div>
                        <CardDetailModal card={detailCard} onClose={() => setDetailCard(null)} />
                </AppScreen>
            );
        };

        // 5. Result Screen
        const ResultScreen = ({ pickedTarots }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const birthData = location.state?.birthData || null;

            const pickedCore = pickedTarots.find((item) => item.deck === 'core');
            const pickedPattern = pickedTarots.find((item) => item.deck === 'pattern');
            const pickedFlow = pickedTarots[pickedTarots.length - 1];

            const core = CORE_CARDS.find((card) => card.id === pickedCore?.id) || CORE_CARDS[0];
            const pattern = PATTERN_CARDS.find((card) => card.id === pickedPattern?.id) || PATTERN_CARDS[0];
            const flow = FLOW_CARDS.find((card) => card.id === pickedFlow?.id) || FLOW_CARDS[0];

            const resultMap = {
                aurora_bay: {
                    label: '오로라 해안',
                    badge: 'AURORA BAY / COAST',
                    type: '회복 균형형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '결을 정리하는',
                    tone: 'cool',
                    summary: '잔잔한 흐름 속에서 감정의 결을 정리하고 회복을 우선할 때입니다.',
                    todayLine: '속도를 줄이고 루틴을 되찾는 선택이 가장 빠른 회복으로 이어집니다.',
                },
                han_river: {
                    label: '한강 라인',
                    badge: 'HAN RIVER / CITY',
                    type: '속도 상승형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '판을 키우는',
                    tone: 'neutral',
                    summary: '확장과 집중이 동시에 필요한 날입니다. 핵심 성과를 전면에 두세요.',
                    todayLine: '가장 큰 기회는 ‘지금 공개’에서 나옵니다.',
                },
                pine_ridge: {
                    label: '소나무 능선',
                    badge: 'PINE RIDGE / MOUNTAIN',
                    type: '정돈 집중형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '안개를 걷는',
                    tone: 'mist',
                    summary: '과한 확장보다 구조 정리가 우선인 흐름입니다.',
                    todayLine: '버릴 것을 먼저 정리하면 길이 또렷해집니다.',
                },
                night_market: {
                    label: '야시장 거리',
                    badge: 'NIGHT MARKET / CITY',
                    type: '기회 확장형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '빛을 모으는',
                    tone: 'warm',
                    summary: '사람과 기회가 모이는 흐름입니다. 연결을 넓히세요.',
                    todayLine: '작은 만남이 큰 기회로 이어질 수 있습니다.',
                },
                dawn_field: {
                    label: '새벽 들판',
                    badge: 'DAWN FIELD / COAST',
                    type: '리듬 회복형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '호흡을 맞추는',
                    tone: 'soft',
                    summary: '무리보다 리듬을 되찾는 것이 핵심인 날입니다.',
                    todayLine: '속도를 낮추면 판단이 선명해집니다.',
                },
                cloud_pass: {
                    label: '구름 고개',
                    badge: 'CLOUD PASS / MOUNTAIN',
                    type: '전환 준비형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '길을 다시 잡는',
                    tone: 'mist',
                    summary: '방향을 다시 잡는 시기입니다. 큰 결정을 늦춰도 좋습니다.',
                    todayLine: '정비가 끝나면 선택이 쉬워집니다.',
                },
                harbor_light: {
                    label: '항구 불빛',
                    badge: 'HARBOR LIGHT / COAST',
                    type: '관계 조율형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '파도를 읽는',
                    tone: 'cool',
                    summary: '관계의 흐름을 정리하고 신뢰를 쌓기 좋은 날입니다.',
                    todayLine: '대화의 온도를 낮추면 더 멀리 갑니다.',
                },
                skyline: {
                    label: '스카이라인',
                    badge: 'SKYLINE / CITY',
                    type: '선명 추진형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '성과를 쌓는',
                    tone: 'neutral',
                    summary: '목표를 더 선명히 보일수록 성과가 빠르게 쌓입니다.',
                    todayLine: '한 가지 목표를 공개하면 추진력이 붙습니다.',
                },
                stone_valley: {
                    label: '바위 계곡',
                    badge: 'STONE VALLEY / MOUNTAIN',
                    type: '내공 축적형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '흐름을 다듬는',
                    tone: 'earth',
                    summary: '느리지만 확실한 축적이 가장 강한 무기입니다.',
                    todayLine: '작은 개선이 누적될수록 결과가 커집니다.',
                },
                tide_bridge: {
                    label: '물결 다리',
                    badge: 'TIDE BRIDGE / COAST',
                    type: '연결 강화형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '신뢰를 잇는',
                    tone: 'soft',
                    summary: '연결과 협업에서 좋은 흐름이 만들어지는 날입니다.',
                    todayLine: '서로의 강점을 이어붙이면 속도가 납니다.',
                },
                city_pulse: {
                    label: '도심 맥박',
                    badge: 'CITY PULSE / CITY',
                    type: '실행 가속형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '결정을 밀어붙이는',
                    tone: 'warm',
                    summary: '지금은 속도를 올려도 되는 구간입니다.',
                    todayLine: '결정을 미루지 말고 실행으로 옮기세요.',
                },
                summit_mist: {
                    label: '정상 안개',
                    badge: 'SUMMIT MIST / MOUNTAIN',
                    type: '리셋 정비형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '방향을 다듬는',
                    tone: 'mist',
                    summary: '흐름을 리셋하고 방향을 정비하는 데 최적인 날입니다.',
                    todayLine: '비운 자리에 새로운 길이 드러납니다.',
                },
            };

            const patternAlias = {
                rush: '직진형',
                plan: '설계형',
                avoid: '거리두기형',
                rely: '협업형',
            };

            const resultKeys = Object.keys(resultMap);
            const hashSeed = `${core.id}:${pattern.id}:${flow.id}`;
            let hashValue = 0;
            for (let i = 0; i < hashSeed.length; i += 1) {
                hashValue = (hashValue * 31 + hashSeed.charCodeAt(i)) % 100000;
            }
            const selectedResult = resultMap[resultKeys[hashValue % resultKeys.length]];
            const characterNameFallback = `${selectedResult.adj} ${patternAlias[pattern.id] || ''} ${core.label}`.replace(/\s+/g, ' ').trim();
            const summaryFallback = selectedResult.summary || flow.meaning.korea;
            const todayLineFallback = selectedResult.todayLine || `${flow.meaning.archetype} 흐름에서, 당신의 강점은 '${core.meaning.strength[0]}'로 드러납니다. 다만 '${pattern.meaning.caution[0]}'에 주의하세요.`;
            const localAnalysisFallback = {
                title: characterNameFallback,
                summary: summaryFallback,
                todayLine: todayLineFallback,
                actions: [
                    { title: '20분 정리 산책', description: '움직이면서 오늘의 우선순위 3가지를 정리해 보세요.' },
                    { title: '한 줄 실행 기록', description: '오늘 완료한 1가지를 기록하면 동기 유지에 도움이 됩니다.' },
                ],
            };

            const [analysisResult, setAnalysisResult] = useState(null);
            const [analysisError, setAnalysisError] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [missingImages, setMissingImages] = useState([]);

            const formatBirthDate = (value) => {
                if (!value) {
                    return '정보 없음';
                }
                return value.replace(/-/g, '. ');
            };
            const formatBirthTime = (data) => {
                if (!data) {
                    return '정보 없음';
                }
                if (data.unknownTime) {
                    return '시간 모름';
                }
                if (data.hour == null || data.minute == null) {
                    return '정보 없음';
                }
                return `${data.hour}:${data.minute}`;
            };
            const formatCalendarType = (value) => {
                if (value === 'lunar') {
                    return '음력';
                }
                return '양력';
            };

            const selectedLabels = [core.label, pattern.label, flow.label];
            const analysisPayload = JSON.stringify({
                birthData,
                pickedTarots: pickedTarots.map((item) => item.id),
                pickedCards: {
                    core,
                    pattern,
                    flow,
                },
                psychVector: birthData?.psychVector || null,
            });

            useEffect(() => {
                let cancelled = false;
                const runAnalysis = async () => {
                    setIsAnalyzing(true);
                    setAnalysisError('');
                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        const publicApiKey = (window.__PUBLIC_API_KEY || '').trim();
                        if (publicApiKey) {
                            headers['X-API-Key'] = publicApiKey;
                        }

                        const baseCandidates = [];
                        const configuredBase = (window.__API_BASE_URL || '').trim();
                        if (configuredBase) {
                            baseCandidates.push(configuredBase.replace(/\/+$/, ''));
                        }
                        baseCandidates.push('');

                        let data = null;
                        let lastError = null;
                        for (const base of baseCandidates) {
                            const endpoint = `${base}/api/analyze`;
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                headers,
                                body: analysisPayload,
                            });
                            if (response.ok) {
                                data = await response.json();
                                break;
                            }

                            if (response.status === 404 || response.status === 405) {
                                lastError = new Error('AI API 경로가 배포에 연결되지 않았습니다.');
                                continue;
                            }

                            const errorBody = await response.json().catch(() => ({}));
                            lastError = new Error(errorBody.error || `분석 요청 실패 (HTTP ${response.status})`);
                            break;
                        }

                        if (!data) {
                            throw (lastError || new Error('AI 분석 요청에 실패했습니다.'));
                        }

                        if (!cancelled) {
                            setAnalysisResult(data.analysis || null);
                        }
                    } catch (error) {
                        if (!cancelled) {
                            setAnalysisResult(localAnalysisFallback);
                            setAnalysisError('');
                        }
                    } finally {
                        if (!cancelled) {
                            setIsAnalyzing(false);
                        }
                    }
                };
                runAnalysis();
                return () => {
                    cancelled = true;
                };
            }, [analysisPayload]);

            useEffect(() => {
                let cancelled = false;
                const entries = Object.values(resultMap);
                const missing = [];
                let resolved = 0;
                const done = () => {
                    if (!cancelled && resolved === entries.length) {
                        setMissingImages(missing);
                    }
                };
                entries.forEach((entry) => {
                    const img = new Image();
                    img.onload = () => {
                        resolved += 1;
                        done();
                    };
                    img.onerror = () => {
                        missing.push(entry.image);
                        resolved += 1;
                        done();
                    };
                    img.src = entry.image;
                });
                return () => {
                    cancelled = true;
                };
            }, []);

            const characterName = analysisResult?.title || characterNameFallback;
            const summary = analysisResult?.summary || summaryFallback;
            const todayLine = analysisResult?.todayLine || todayLineFallback;
            const advicePrimary = analysisResult?.actions?.[0] || null;
            const adviceSecondary = analysisResult?.actions?.[1] || null;

            const handleWalkAction = () => {
                window.open('https://www.google.com/search?q=20%EB%B6%84+%ED%83%80%EC%9D%B4%EB%A8%B8', '_blank', 'noopener,noreferrer');
            };
            const handleNoteAction = () => {
                const input = window.prompt('오늘 완료한 1가지를 기록해 보세요.');
                if (input == null) {
                    return;
                }
                const memo = input.trim();
                if (!memo) {
                    window.alert('내용을 입력해 주세요.');
                    return;
                }
                const payload = {
                    memo,
                    createdAt: new Date().toISOString(),
                };
                window.localStorage.setItem('life_position_daily_note', JSON.stringify(payload));
                window.alert('기록이 저장되었습니다.');
            };
            const handleShareResult = async () => {
                const shareText = [
                    `선택 카드: ${selectedLabels.join(' -> ')}`,
                    `캐릭터: ${characterName}`,
                    `요약: ${summary}`,
                ].join('\n');
                try {
                    if (navigator.share) {
                        await navigator.share({
                            title: '인생 포지션 분석 결과',
                            text: shareText,
                        });
                        return;
                    }
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(shareText);
                        window.alert('분석 결과가 클립보드에 복사되었습니다.');
                        return;
                    }
                    window.alert(shareText);
                } catch (error) {
                    window.alert(`공유 중 오류가 발생했습니다: ${error?.message || error}`);
                }
            };

            const toneOverlay = {
                cool: 'linear-gradient(180deg, rgba(9,30,66,0.05) 0%, rgba(10,37,63,0.35) 100%)',
                warm: 'linear-gradient(180deg, rgba(69,26,3,0.05) 0%, rgba(120,53,15,0.35) 100%)',
                mist: 'linear-gradient(180deg, rgba(15,23,42,0.05) 0%, rgba(71,85,105,0.35) 100%)',
                soft: 'linear-gradient(180deg, rgba(14,116,144,0.05) 0%, rgba(30,64,175,0.25) 100%)',
                earth: 'linear-gradient(180deg, rgba(30,41,59,0.05) 0%, rgba(99,102,241,0.25) 100%)',
                neutral: 'linear-gradient(180deg, rgba(2,6,23,0.02) 0%, rgba(30,41,59,0.2) 100%)',
            };

            return (
                <AppScreen outerClassName="selection:bg-primary/30" frameClassName="font-display text-slate-900 dark:text-slate-100 mx-auto">
                        <header className="flex items-center px-4 py-3 sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-100/50 dark:border-slate-800/50">
                            <button
                                onClick={() => navigate(-1)}
                                className="text-slate-900 dark:text-slate-100 flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"
                            >
                                <span className="material-symbols-outlined">arrow_back</span>
                            </button>
                            <h1 className="text-slate-900 dark:text-slate-100 text-base font-bold flex-1 text-center tracking-tight">인생 포지션 분석</h1>
                            <button className="text-slate-900 dark:text-slate-100 flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                                <span className="material-symbols-outlined">more_vert</span>
                            </button>
                        </header>
                        <main className="min-h-0 flex-1 flex flex-col overflow-y-auto no-scrollbar pb-32 px-5">
                            <div className="mt-3 mb-2">
                                <div className="flex justify-between items-end px-1 mb-2">
                                    <span className="text-[11px] font-semibold text-primary/80 uppercase tracking-wider">결과 단계</span>
                                    <span className="text-sm font-bold text-primary">4 <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ 4</span></span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full" style={{ width: '100%' }}></div>
                                </div>
                                <p className="mt-2 text-[11px] text-slate-500 dark:text-slate-400">
                                    선택 카드: {selectedLabels.join(' → ')}
                                </p>
                            </div>
                            {missingImages.length > 0 && (
                                <div className="mt-2 text-[11px] text-amber-600 dark:text-amber-400 bg-amber-50/70 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl px-3 py-2">
                                    누락된 결과 이미지가 있습니다: {missingImages.join(', ')}
                                </div>
                            )}
                            {isAnalyzing && (
                                <p className="mt-1 text-xs font-semibold text-primary">OpenAI 분석 중입니다...</p>
                            )}
                            {analysisError && (
                                <p className="mt-1 text-xs font-semibold text-rose-500">OpenAI 연결 오류: {analysisError}</p>
                            )}
                            <div className="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl p-4 shadow-card text-sm text-slate-600 dark:text-slate-300">
                                <div className="flex items-center justify-between">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">생년월일</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatBirthDate(birthData?.date)}</span>
                                </div>
                                <div className="flex items-center justify-between mt-2">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">태어난 시간</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatBirthTime(birthData)}</span>
                                </div>
                                <div className="flex items-center justify-between mt-2">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">달력 기준</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatCalendarType(birthData?.calendarType)}</span>
                                </div>
                            </div>
                            <div className="relative w-full aspect-[4/5] mt-4 rounded-2xl overflow-hidden shadow-soft group mx-auto max-w-[360px]">
                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style={{ backgroundImage: `url('${selectedResult.image}')` }}></div>
                                <div className="absolute inset-0 bg-gradient-to-t from-background-light dark:from-background-dark via-transparent to-transparent opacity-80"></div>
                                <div className="absolute inset-0 mix-blend-overlay" style={{ background: toneOverlay[selectedResult.tone] || toneOverlay.neutral }}></div>
                                <div className="absolute top-4 left-4 bg-surface-light/30 dark:bg-surface-dark/30 backdrop-blur-md border border-white/20 px-3 py-1 rounded-full flex items-center gap-1.5 shadow-lg">
                                    <span className="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
                                    <span className="text-[10px] font-bold text-white tracking-widest uppercase">{selectedResult.badge}</span>
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-6 flex flex-col items-center text-center translate-y-2">
                                    <div className="inline-block px-3 py-1 mb-2 rounded-full bg-primary/90 backdrop-blur-sm shadow-glow border border-primary/20">
                                        <span className="text-[11px] font-bold text-white uppercase tracking-wider">{selectedResult.type}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col items-center text-center mt-6 mb-8">
                                <h2 className="text-4xl font-black text-slate-900 dark:text-white leading-[1.1] tracking-tight mb-3">
                                    {characterName}
                                </h2>
                                <div className="h-px w-8 bg-primary/30 my-3"></div>
                                <p className="text-secondary-text dark:text-slate-400 text-sm font-medium italic mt-1 max-w-[300px] leading-relaxed opacity-90">
                                    "{summary}"
                                </p>
                            </div>
                            <div className="space-y-6">
                                <div className="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-card relative overflow-hidden group">
                                    <div className="absolute -right-4 -top-4 w-24 h-24 bg-primary/5 rounded-full blur-2xl pointer-events-none"></div>
                                    <div className="flex items-center gap-2.5 mb-4 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <span className="material-symbols-outlined text-primary text-xl">terminal</span>
                                        <h3 className="text-sm font-bold uppercase tracking-wider text-slate-900 dark:text-white">오늘의 종합 해석</h3>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex items-center">
                                            <span className="inline-flex items-center px-2 py-1 rounded bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs font-bold font-mono">
                                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5 animate-pulse"></span>
                                                STATUS: {flow.stateTag}
                                            </span>
                                        </div>
                                        <p className="text-sm text-slate-600 dark:text-slate-300 leading-7 font-normal">{todayLine}</p>
                                    </div>
                                </div>
                                <div className="pt-2">
                                    <div className="flex items-center gap-2 mb-4 px-1">
                                        <span className="flex h-2 w-2 relative">
                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                                            <span className="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                                        </span>
                                        <h3 className="text-sm font-bold text-slate-900 dark:text-white tracking-tight">오늘의 추천 행동</h3>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        <button
                                            onClick={handleWalkAction}
                                            className="flex items-center p-4 bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm active:scale-[0.98] transition-all group text-left"
                                        >
                                            <div className="w-12 h-12 rounded-xl bg-primary/5 dark:bg-white/5 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors duration-300 shrink-0">
                                                <span className="material-symbols-outlined text-[24px]">smartphone</span>
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <h4 className="text-[15px] font-bold text-slate-900 dark:text-white mb-1 group-hover:text-primary transition-colors">
                                                    {advicePrimary?.title || flow.meaning.advice[0]}
                                                </h4>
                                                <p className="text-[13px] text-slate-500 dark:text-slate-400 leading-tight">
                                                    {advicePrimary?.description || core.meaning.advice[0]}
                                                </p>
                                            </div>
                                            <span className="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-lg">arrow_forward_ios</span>
                                        </button>
                                        <button
                                            onClick={handleNoteAction}
                                            className="flex items-center p-4 bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm active:scale-[0.98] transition-all group text-left"
                                        >
                                            <div className="w-12 h-12 rounded-xl bg-primary/5 dark:bg-white/5 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors duration-300 shrink-0">
                                                <span className="material-symbols-outlined text-[24px]">edit_note</span>
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <h4 className="text-[15px] font-bold text-slate-900 dark:text-white mb-1 group-hover:text-primary transition-colors">
                                                    {adviceSecondary?.title || flow.meaning.advice[1]}
                                                </h4>
                                                <p className="text-[13px] text-slate-500 dark:text-slate-400 leading-tight">
                                                    {adviceSecondary?.description || pattern.meaning.advice[0]}
                                                </p>
                                            </div>
                                            <span className="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-lg">arrow_forward_ios</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">
                                    선택 카드: {selectedLabels.join(' · ')}
                                </div>
                            </div>
                        </main>
                        <div className="absolute bottom-0 left-0 right-0 w-full p-5 pb-8 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 z-40 pointer-events-none h-32 flex items-end">
                            <button
                                onClick={handleShareResult}
                                className="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 px-6 rounded-2xl shadow-glow flex items-center justify-center gap-3 transition-all active:scale-[0.97] pointer-events-auto"
                            >
                                <span className="material-symbols-outlined text-[22px]">ios_share</span>
                                <span className="text-[15px] tracking-wide">분석 결과 공유하기</span>
                            </button>
                        </div>
                </AppScreen>
            );
        };

        // --- App Shell ---
        const App = () => {
            const [pickedTarots, setPickedTarots] = useState([]);
            return (
                <HashRouter>
                    <Routes>
                        <Route path="/" element={<LandingScreen />} />
                        <Route path="/birth" element={<BirthInputScreen />} />
                        <Route path="/analysis" element={<AnalysisScreen />} />
                        <Route path="/tarot" element={<TarotScreen pickedTarots={pickedTarots} setPickedTarots={setPickedTarots} />} />
                        <Route path="/result" element={<ResultScreen pickedTarots={pickedTarots} />} />
                    </Routes>
                </HashRouter>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        window.__APP_RENDERED__ = true;
        } catch (error) {
            const root = document.getElementById('root');
            if (root) {
                root.textContent = `앱 초기화 실패: ${error?.message || error}`;
            }
        }
    </script>
</body>
</html>
