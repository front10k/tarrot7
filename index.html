<!DOCTYPE html>
<html lang="ko" class="">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Life Position - 인생 포지션 분석</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- React Router -->
    <script src="https://unpkg.com/history@5/umd/history.development.js"></script>
    <script src="https://unpkg.com/react-router@6.3.0/umd/react-router.development.js"></script>
    <script src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,line-clamp"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

    <script>
        window.addEventListener('load', () => {
            const root = document.getElementById('root');
            if (!root) return;
            if (!window.React || !window.ReactDOM) {
                root.textContent = 'React 로딩 실패: 외부 CDN 연결을 확인해 주세요.';
                return;
            }
            if (!window.Babel) {
                root.textContent = 'Babel 로딩 실패: 외부 CDN 연결을 확인해 주세요.';
            }
        });
    </script>

    <!-- Theme Configuration -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#7f13ec",
                        "primary-light": "#9e4bf3",
                        "primary-lighter": "#efe6fd",
                        "background-light": "#f7f6f8",
                        "background-dark": "#191022",
                        "surface-light": "#ffffff",
                        "surface-dark": "#2a2235", // Combined/averaged from screens
                        "text-main": "#140d1b",
                        "text-sub": "#734c9a",
                        "secondary-text": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "Noto Sans KR", "sans-serif"],
                        "sans": ["Plus Jakarta Sans", "Noto Sans KR", "sans-serif"],
                    },
                    borderRadius: {
                        "DEFAULT": "1rem", 
                        "lg": "2rem", 
                        "xl": "3rem", 
                        "full": "9999px",
                        "md": "0.5rem",
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    },
                    boxShadow: {
                        "soft": "0 4px 20px -2px rgba(127, 19, 236, 0.08)",
                        "glow": "0 0 15px rgba(127, 19, 236, 0.3)",
                        "card": "0 2px 8px rgba(0, 0, 0, 0.04)",
                    }
                },
            },
        }
    </script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans KR', sans-serif;
            -webkit-font-smoothing: antialiased;
            min-height: 100dvh;
            background-color: #f7f6f8;
        }
        .text-gradient {
            background: linear-gradient(135deg, #7f13ec 0%, #b06bf7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .peer:checked ~ .card-ring {
            border-color: #7f13ec;
            background-color: rgba(127, 19, 236, 0.03);
            box-shadow: 0 4px 12px rgba(127, 19, 236, 0.1);
        }
        .peer:checked ~ .card-ring .radio-indicator {
            background-color: #7f13ec;
            border-color: #7f13ec;
        }
        .peer:checked ~ .card-ring .radio-indicator::after {
            transform: scale(1);
        }
        .radio-indicator::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.2s ease-in-out;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tarot-strip {
            position: relative;
            scroll-behavior: smooth;
        }
        .tarot-strip::before,
        .tarot-strip::after {
            content: '';
            position: sticky;
            top: 0;
            width: 24px;
            min-width: 24px;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        .tarot-strip::before {
            left: 0;
            background: linear-gradient(90deg, rgba(247, 246, 248, 0.95), rgba(247, 246, 248, 0));
        }
        .tarot-strip::after {
            right: 0;
            background: linear-gradient(270deg, rgba(247, 246, 248, 0.95), rgba(247, 246, 248, 0));
        }
        html.dark .tarot-strip::before {
            background: linear-gradient(90deg, rgba(25, 16, 34, 0.95), rgba(25, 16, 34, 0));
        }
        html.dark .tarot-strip::after {
            background: linear-gradient(270deg, rgba(25, 16, 34, 0.95), rgba(25, 16, 34, 0));
        }
        .tarot-strip-card {
            animation: strip-float 6s ease-in-out infinite;
        }
        .tarot-strip-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.18) 50%, rgba(255, 255, 255, 0) 70%);
            transform: translateX(-120%);
            animation: strip-shimmer 5.2s ease-in-out infinite;
            opacity: 0.5;
            pointer-events: none;
        }
        .tarot-strip-card:nth-child(3n) {
            animation-delay: -1.5s;
        }
        .tarot-strip-card:nth-child(4n) {
            animation-delay: -2.5s;
        }
        .tarot-strip-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            padding: 2px 6px;
            border-radius: 9999px;
            background: rgba(127, 19, 236, 0.9);
            color: #ffffff;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(127, 19, 236, 0.35);
            pointer-events: none;
        }
        @keyframes strip-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes strip-shimmer {
            0% { transform: translateX(-140%); }
            55% { transform: translateX(140%); }
            100% { transform: translateX(140%); }
        }
        .card-stack {
            position: relative;
            height: 320px;
            width: 220px;
            margin: 0 auto;
            perspective: 1000px;
        }
        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: linear-gradient(135deg, #1f122e 0%, #7f13ec 100%);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: bottom center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
        }
        .card:nth-child(1) { transform: rotate(-10deg) translateY(10px); z-index: 1; }
        .card:nth-child(2) { transform: rotate(-5deg) translateY(5px); z-index: 2; }
        .card:nth-child(3) { transform: rotate(0deg) translateY(0px); z-index: 3; }
        .card:nth-child(4) { transform: rotate(5deg) translateY(5px); z-index: 2; }
        .card:nth-child(5) { transform: rotate(10deg) translateY(10px); z-index: 1; }
        .card-stack:hover .card:nth-child(1) { transform: rotate(-20deg) translateY(20px) translateX(-20px); }
        .card-stack:hover .card:nth-child(2) { transform: rotate(-10deg) translateY(10px) translateX(-10px); }
        .card-stack:hover .card:nth-child(3) { transform: translateY(-10px) scale(1.05); z-index: 10; box-shadow: 0 0 20px rgba(127, 19, 236, 0.4); }
        .card-stack:hover .card:nth-child(4) { transform: rotate(10deg) translateY(10px) translateX(10px); }
        .card-stack:hover .card:nth-child(5) { transform: rotate(20deg) translateY(20px) translateX(20px); }
        .card-pattern {
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        .word-keep-all {
            word-break: keep-all;
        }
    </style>
  </head>
<body>
    <div id="root" style="min-height:100vh; display:flex; align-items:center; justify-content:center; color:#111; font-family: 'Plus Jakarta Sans','Noto Sans KR',sans-serif; background:#f7f6f8;">
        <div style="text-align:center; max-width:420px; padding:24px;">
            <div style="font-weight:800; font-size:20px; margin-bottom:8px;">Life Position</div>
            <div style="color:#555; font-size:14px;">화면을 준비하고 있어요...</div>
        </div>
    </div>
    <noscript>
        <div style="padding:16px; color:#111; font-family: 'Plus Jakarta Sans','Noto Sans KR',sans-serif;">
            JavaScript가 비활성화되어 있어 화면을 표시할 수 없습니다.
        </div>
    </noscript>

    <script type="text/babel" data-presets="env,react">
        try {
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;
        const { HashRouter, Routes, Route, Link, useNavigate, useLocation } = ReactRouterDOM;

        // --- Components ---
        const APP_OUTER_CLASS = 'bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-[100dvh] h-[100dvh] flex justify-center overflow-hidden w-full';
        const APP_FRAME_CLASS = 'relative w-full max-w-[430px] min-h-[100dvh] h-[100dvh] max-h-[100dvh] bg-background-light dark:bg-background-dark flex flex-col overflow-hidden shadow-2xl';
        const AppScreen = ({ children, outerClassName = '', frameClassName = '' }) => (
            <div className={`${APP_OUTER_CLASS} ${outerClassName}`.trim()}>
                <div className={`${APP_FRAME_CLASS} ${frameClassName}`.trim()}>
                    {children}
                </div>
            </div>
        );

        // 1. Landing Screen
        const LandingScreen = () => {
            const navigate = useNavigate();
            return (
                <AppScreen frameClassName="text-slate-900 dark:text-slate-100">
                    <nav className="flex items-center justify-between p-6 z-10 relative">
                        <button className="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                            <span className="material-symbols-outlined text-slate-900 dark:text-slate-100" style={{ fontSize: '28px' }}>menu</span>
                        </button>
                        <div className="flex items-center gap-1">
                            <span className="text-xs font-bold tracking-widest uppercase text-slate-400 dark:text-slate-500">Life Position</span>
                        </div>
                        <button className="flex items-center justify-center p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
                            <span className="material-symbols-outlined text-slate-900 dark:text-slate-100" style={{ fontSize: '28px' }}>account_circle</span>
                        </button>
                    </nav>

                    <main className="flex-1 flex flex-col items-center justify-center relative w-full max-w-[430px] mx-auto px-6 pb-24">
                        <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 bg-primary/20 rounded-full blur-[100px] pointer-events-none"></div>
                        <div className="relative w-full aspect-square max-w-[320px] flex items-center justify-center mb-8 animate-float">
                            <div className="absolute inset-0 border border-primary/10 rounded-full scale-110 animate-pulse-slow"></div>
                            <div className="absolute inset-0 border border-primary/5 rounded-full scale-125"></div>
                            <div className="relative w-full h-full rounded-3xl overflow-hidden shadow-2xl shadow-primary/20" style={{ background: 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent), linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%)' }}>
                                <img alt="Abstract floating 3D crystal prism purple gradient" className="w-full h-full object-cover mix-blend-overlay opacity-80" data-alt="Futuristic 3D floating crystal prism representing data analysis engine" src="https://lh3.googleusercontent.com/aida-public/AB6AXuDMJM7G3hnXsTkJCuVrttKtDEoGR48Jg7_qyaRJwDspjOjOnysKw9RtUHsEt_6z-cglMtJdr1Fr5qjQ6PL-z5ptF0U8mThf7s9_n2pHREvaPB0KCcEBO7yHMj1RLF41Tm-_lg5FRxrlhix793nOTWF4FvTQIvIC5EpYkrc_owvyyed9VdHzen29lg8yTDsCMH45xnTlBDMG0mP8uPYevr3gKFHrn2RFNQX0dPkPaHH9ujH8tPg9HZZuLKWUXuL3-YdJuFET3-hmgg" />
                                <div className="absolute top-0 right-0 w-full h-full bg-gradient-to-tr from-transparent via-white/30 to-transparent opacity-50"></div>
                            </div>
                        </div>
                        <div className="text-center space-y-3 z-10 relative">
                            <h1 className="text-[40px] font-black leading-tight tracking-tight text-slate-900 dark:text-white">
                                <span className="text-gradient">인생 포지션</span>
                            </h1>
                            <p className="text-base font-medium text-slate-500 dark:text-slate-400 keep-all">
                                질문부터 사주, 타로까지 이어지는<br />개인화 분석을 시작해보세요
                            </p>
                        </div>
                    </main>

                    <footer className="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-background-light via-background-light/90 to-transparent dark:from-background-dark dark:via-background-dark/90 pb-8 pt-12 z-20">
                        <div className="max-w-[430px] mx-auto flex flex-col gap-4">
                            <button 
                                onClick={() => navigate('/analysis')}
                                className="w-full h-14 bg-primary hover:bg-primary-light active:scale-[0.98] transition-all duration-200 text-white rounded-full font-bold text-lg shadow-lg shadow-primary/30 flex items-center justify-center gap-2 group"
                            >
                                <span>질문(설문) 시작하기</span>
                                <span className="material-symbols-outlined transition-transform group-hover:translate-x-1" style={{ fontSize: '20px' }}>arrow_forward</span>
                            </button>
                            <button className="w-full py-2 text-sm font-medium text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary-light transition-colors flex items-center justify-center gap-1">
                                <span className="material-symbols-outlined" style={{ fontSize: '18px' }}>history</span>
                                이전 결과 확인
                            </button>
                        </div>
                    </footer>
                </AppScreen>
            );
        };

        // 2. Birth Input Screen
        const BirthInputScreen = () => {
            const navigate = useNavigate();
            const location = useLocation();
            const psychVector = location.state?.psychVector || null;
            const answers = location.state?.answers || null;
            const [calendarType, setCalendarType] = useState('solar');
            const [birthDate, setBirthDate] = useState('1997-09-01');
            const [hour, setHour] = useState('10');
            const [minute, setMinute] = useState('30');
            const [isUnknownTime, setIsUnknownTime] = useState(false);

            const formattedDate = birthDate
                ? birthDate.replace(/-/g, '. ')
                : '날짜 선택';
            const formattedTime = isUnknownTime ? '시간 모름' : `${hour}:${minute}`;

            return (
                <AppScreen frameClassName="text-slate-900 dark:text-slate-100">
                        <header className="flex items-center px-4 py-4 sticky top-0 z-20 bg-background-light dark:bg-background-dark">
                            <button 
                                onClick={() => navigate(-1)}
                                className="w-11 h-11 flex items-center justify-center rounded-full hover:bg-primary/10 transition-colors text-slate-900 dark:text-slate-100"
                            >
                                <span className="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                            </button>
                            <h1 className="flex-1 text-center text-xl font-bold tracking-tight">출생 정보 입력</h1>
                            <div className="w-11"></div>
                        </header>
                        <main className="flex-1 overflow-y-auto pb-32 px-6 no-scrollbar">
                            <div className="mt-1 mb-4">
                                <div className="flex justify-between items-end px-1 mb-2">
                                    <span className="text-[11px] font-semibold text-primary/80 uppercase tracking-wider">사주 단계</span>
                                    <span className="text-sm font-bold text-primary">2 <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ 4</span></span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full" style={{ width: '50%' }}></div>
                                </div>
                                <p className="mt-2 text-[11px] text-slate-500 dark:text-slate-400">예상 소요 시간: 1분</p>
                            </div>
                            <div className="mt-4 mb-8">
                                <h2 className="text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white mb-3 leading-tight">
                                    언제 <br /><span className="text-primary">태어나셨나요?</span>
                                </h2>
                                <p className="text-slate-500 dark:text-slate-400 text-sm leading-relaxed flex items-start gap-2">
                                    <span className="material-symbols-outlined text-primary text-[18px] mt-0.5">lock</span>
                                    <span>정확한 사주 분석을 위해 생년월일시가 필요합니다. 토큰 기반 접근과 HTTPS로 안전하게 처리됩니다.</span>
                                </p>
                            </div>
                            <div className="bg-surface-light dark:bg-surface-dark p-1 rounded-xl flex shadow-sm border border-slate-100 dark:border-slate-800 mb-8 h-[52px]">
                                <button
                                    type="button"
                                    onClick={() => setCalendarType('solar')}
                                    className={`flex-1 rounded-lg text-sm font-bold transition-all flex items-center justify-center ${
                                        calendarType === 'solar'
                                            ? 'bg-primary text-white shadow-md'
                                            : 'text-slate-500 dark:text-slate-400 hover:text-primary'
                                    }`}
                                >
                                    양력
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setCalendarType('lunar')}
                                    className={`flex-1 rounded-lg text-sm font-bold transition-all flex items-center justify-center ${
                                        calendarType === 'lunar'
                                            ? 'bg-primary text-white shadow-md'
                                            : 'text-slate-500 dark:text-slate-400 hover:text-primary'
                                    }`}
                                >
                                    음력
                                </button>
                            </div>
                            <section className="mb-10">
                                <div className="flex items-center justify-between mb-3 px-1">
                                    <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">생년월일</h2>
                                </div>
                                <div className="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 p-4 flex items-center justify-between shadow-sm active:border-primary active:ring-1 active:ring-primary transition-all group min-h-[72px]">
                                    <div className="flex items-center gap-4">
                                        <div className="bg-primary/10 w-12 h-12 flex items-center justify-center rounded-full text-primary">
                                            <span className="material-symbols-outlined text-[24px]">calendar_today</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-xs text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider mb-0.5">선택된 날짜</span>
                                            <span className="text-xl font-bold text-slate-900 dark:text-white">{formattedDate}</span>
                                        </div>
                                    </div>
                                    <span className="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors text-[24px]">
                                        calendar_month
                                    </span>
                                </div>
                                <div className="mt-4">
                                    <input
                                        type="date"
                                        className="h-14 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark px-4 text-base text-slate-900 dark:text-white font-semibold"
                                        value={birthDate}
                                        onChange={(event) => setBirthDate(event.target.value)}
                                    />
                                </div>
                                <p className="mt-2 text-xs text-slate-400 dark:text-slate-500 px-2 leading-relaxed">
                                    * 수집된 생년월일은 사주 분석 목적으로만 사용되며, 외부에 공개되지 않습니다.
                                </p>
                            </section>
                            <section className="mb-8 relative">
                                <div className="flex items-center justify-between mb-3 px-1">
                                    <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">태어난 시간</h2>
                                    <label className="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                                        <input
                                            className="accent-primary w-4 h-4"
                                            type="checkbox"
                                            checked={isUnknownTime}
                                            onChange={(event) => setIsUnknownTime(event.target.checked)}
                                        />
                                        모름
                                    </label>
                                </div>
                                <div className="relative bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm p-5">
                                    <div className="flex items-center gap-4 mb-5">
                                        <div className="bg-primary/10 w-12 h-12 flex items-center justify-center rounded-full text-primary">
                                            <span className="material-symbols-outlined text-[24px]">schedule</span>
                                        </div>
                                        <div>
                                            <p className="text-xs text-slate-500 dark:text-slate-400">선택된 시간</p>
                                            <p className="text-2xl font-bold tracking-wide text-slate-900 dark:text-white">{formattedTime}</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="flex flex-col gap-1">
                                            <label className="text-sm text-slate-500 dark:text-slate-400">시</label>
                                            <select
                                                className="h-12 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark text-base text-slate-900 dark:text-white font-semibold"
                                                value={hour}
                                                onChange={(event) => setHour(event.target.value)}
                                                disabled={isUnknownTime}
                                            >
                                                {Array.from({ length: 24 }, (_, idx) => String(idx).padStart(2, '0')).map((value) => (
                                                    <option key={value} value={value}>{value}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <label className="text-sm text-slate-500 dark:text-slate-400">분</label>
                                            <select
                                                className="h-12 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark text-base text-slate-900 dark:text-white font-semibold"
                                                value={minute}
                                                onChange={(event) => setMinute(event.target.value)}
                                                disabled={isUnknownTime}
                                            >
                                                {Array.from({ length: 60 }, (_, idx) => String(idx).padStart(2, '0')).map((value) => (
                                                    <option key={value} value={value}>{value}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <p className="mt-2 text-xs text-slate-400 dark:text-slate-500 px-2 leading-relaxed">
                                    * 정확한 시(時)를 모를 경우 '모름'을 체크해주세요. 평균적인 운세로 분석됩니다.
                                </p>
                                <div className="mt-8">
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <h2 className="text-base font-bold text-slate-900 dark:text-slate-100">성별</h2>
                                    </div>
                                    <div className="flex gap-4">
                                        <label className="cursor-pointer flex-1">
                                            <input defaultChecked className="peer sr-only" name="gender" type="radio" />
                                            <div className="flex items-center justify-center h-14 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-surface-dark peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white transition-all shadow-sm gap-2">
                                                <span className="material-symbols-outlined text-[20px]">female</span>
                                                <span className="text-base font-bold">여성</span>
                                            </div>
                                        </label>
                                        <label className="cursor-pointer flex-1">
                                            <input className="peer sr-only" name="gender" type="radio" />
                                            <div className="flex items-center justify-center h-14 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-surface-light dark:bg-surface-dark peer-checked:bg-primary peer-checked:border-primary peer-checked:text-white transition-all shadow-sm gap-2">
                                                <span className="material-symbols-outlined text-[20px]">male</span>
                                                <span className="text-base font-bold">남성</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </section>
                        </main>
                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light via-background-light to-transparent dark:from-background-dark dark:via-background-dark pt-12">
                            <button 
                                onClick={() => navigate('/tarot', {
                                    state: {
                                        birthData: {
                                            calendarType,
                                            date: birthDate,
                                            hour: isUnknownTime ? null : hour,
                                            minute: isUnknownTime ? null : minute,
                                            unknownTime: isUnknownTime,
                                            psychVector,
                                            answers,
                                        },
                                    },
                                })}
                                className="w-full h-14 bg-primary hover:bg-violet-700 text-white text-lg font-bold rounded-2xl shadow-lg shadow-primary/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2 group"
                            >
                                <span>사주 분석 완료</span>
                                <span className="material-symbols-outlined group-hover:translate-x-1 transition-transform text-[24px]">arrow_forward</span>
                            </button>
                            <p className="mt-3 text-[11px] text-center text-slate-400 dark:text-slate-500 font-medium">
                                개인정보는 서비스 이용 후 즉시 파기됩니다.
                            </p>
                        </div>
                </AppScreen>
            );
        };

        const SCORE = {
            A: { action: 3, emotion: -1, social: 1, stability: -2 },
            B: { action: 1, emotion: 1, social: 0, stability: 1 },
            C: { action: -1, emotion: 2, social: -1, stability: 2 },
            D: { action: -3, emotion: 3, social: -2, stability: 3 },
        };

        const QUESTIONS = [
            {
                axis: 'action',
                text: '해야 할 일이 몰리면?',
                options: {
                    A: '일단 하나라도 바로 처리한다',
                    B: '우선순위를 정하고 순서대로 한다',
                    C: '분석하다 시간이 간다',
                    D: '잠깐 피하고 싶어진다',
                },
            },
            {
                axis: 'action',
                text: '새로운 제안이 들어오면?',
                options: {
                    A: '바로 “해보자”가 나온다',
                    B: '조건/일정을 먼저 확인한다',
                    C: '리스크를 먼저 따져본다',
                    D: '누가 같이 해주면 한다',
                },
            },
            {
                axis: 'action',
                text: '결정을 내려야 할 때',
                options: {
                    A: '감으로 빨리 고른다',
                    B: '비교 후 선택한다',
                    C: '계속 고민한다',
                    D: '남이 정해주면 편하다',
                },
            },
            {
                axis: 'action',
                text: '계획이 틀어졌을 때',
                options: {
                    A: '즉시 대안을 실행한다',
                    B: '재정리 후 조정한다',
                    C: '멈추고 원인부터 본다',
                    D: '일단 상황이 지나가길 기다린다',
                },
            },
            {
                axis: 'emotion',
                text: '비판을 들었을 때',
                options: {
                    A: '“오케이” 하고 바로 바꾼다',
                    B: '받아들이되 감정은 정리한다',
                    C: '하루 종일 신경 쓰인다',
                    D: '관계/상황을 피하고 싶다',
                },
            },
            {
                axis: 'emotion',
                text: '중요한 일이 가까워질수록',
                options: {
                    A: '오히려 에너지가 난다',
                    B: '루틴을 잡고 차분히 준비한다',
                    C: '불안이 올라온다',
                    D: '회피/미루기가 생긴다',
                },
            },
            {
                axis: 'emotion',
                text: '감정 표현 방식',
                options: {
                    A: '바로 말한다',
                    B: '정리해서 말한다',
                    C: '속으로 곱씹는다',
                    D: '말 안 하고 거리를 둔다',
                },
            },
            {
                axis: 'emotion',
                text: '후회가 생기면',
                options: {
                    A: '다음 행동으로 덮는다',
                    B: '교훈으로 정리한다',
                    C: '계속 되새긴다',
                    D: '생각을 끊으려고 회피한다',
                },
            },
            {
                axis: 'social',
                text: '고민이 생기면',
                options: {
                    A: '혼자 결론 내린다',
                    B: '한 명에게만 공유한다',
                    C: '여러 사람 의견을 듣는다',
                    D: '누가 이끌어주길 바란다',
                },
            },
            {
                axis: 'social',
                text: '연락 스타일',
                options: {
                    A: '필요할 때만 깔끔하게',
                    B: '주기적으로 안부',
                    C: '상대 반응에 따라 흔들림',
                    D: '먼저 연락하기 어렵다',
                },
            },
            {
                axis: 'social',
                text: '모임에서 내 포지션',
                options: {
                    A: '분위기 주도',
                    B: '필요한 말만 정리',
                    C: '관찰/청취 중심',
                    D: '피곤해서 빠지고 싶다',
                },
            },
            {
                axis: 'social',
                text: '갈등이 생기면',
                options: {
                    A: '바로 대화로 푼다',
                    B: '타이밍을 보고 조정한다',
                    C: '분석하다 더 어렵다',
                    D: '멀어지며 정리한다',
                },
            },
            {
                axis: 'stability',
                text: '큰 변화가 오면',
                options: {
                    A: '기회라고 느낀다',
                    B: '준비해서 적응한다',
                    C: '불안해서 계획을 더 세운다',
                    D: '변화 자체를 피하고 싶다',
                },
            },
            {
                axis: 'stability',
                text: '실패했을 때',
                options: {
                    A: '재도전한다',
                    B: '수정해서 다시 한다',
                    C: '의미를 분석하다 멈춘다',
                    D: '그 일은 손 떼고 싶다',
                },
            },
            {
                axis: 'stability',
                text: '불확실한 상황에서',
                options: {
                    A: '들어가서 배운다',
                    B: '정보 수집 후 들어간다',
                    C: '계속 확신이 안 선다',
                    D: '결정 자체가 부담이다',
                },
            },
            {
                axis: 'stability',
                text: '책임을 져야 할 때',
                options: {
                    A: '내가 맡는다',
                    B: '역할을 나눈다',
                    C: '부담이 커진다',
                    D: '피할 수 있으면 피한다',
                },
            },
        ];

        // 3. Analysis (Quiz) Screen
        const AnalysisScreen = () => {
            const navigate = useNavigate();
            const [currentIndex, setCurrentIndex] = useState(0);
            const [answers, setAnswers] = useState([]);
            const [selectedChoice, setSelectedChoice] = useState('');
            const [scores, setScores] = useState({
                action: 0,
                emotion: 0,
                social: 0,
                stability: 0,
            });
            const currentQuestion = QUESTIONS[currentIndex];
            const progress = Math.round(((currentIndex + 1) / QUESTIONS.length) * 100);

            const applyScore = (base, delta) => ({
                action: base.action + delta.action,
                emotion: base.emotion + delta.emotion,
                social: base.social + delta.social,
                stability: base.stability + delta.stability,
            });

            useEffect(() => {
                setSelectedChoice('');
            }, [currentIndex]);

            const handleSelect = (choice) => {
                setSelectedChoice(choice);
            };

            const handleNextQuestion = () => {
                if (!selectedChoice) return;
                const nextScores = applyScore(scores, SCORE[selectedChoice]);
                const nextAnswers = [...answers, selectedChoice];
                const isLast = currentIndex + 1 >= QUESTIONS.length;

                setScores(nextScores);
                setAnswers(nextAnswers);

                if (isLast) {
                    navigate('/birth', { state: { psychVector: nextScores, answers: nextAnswers } });
                    return;
                }

                setCurrentIndex((prev) => prev + 1);
            };

            return (
                <AppScreen outerClassName="font-sans antialiased selection:bg-primary selection:text-white" frameClassName="text-text-main dark:text-slate-100">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none" data-alt="Soft purple glow decorative element"></div>
                        <div className="absolute bottom-0 left-0 w-80 h-80 bg-primary/5 rounded-full blur-3xl -ml-20 -mb-20 pointer-events-none" data-alt="Soft purple glow decorative element"></div>
                        <header className="relative z-10 pt-6 px-6 pb-4">
                            <div className="flex items-center justify-between mb-6">
                                <button 
                                    onClick={() => navigate('/')}
                                    className="p-2 -ml-2 text-slate-500 hover:text-primary transition-colors duration-200 rounded-full hover:bg-primary/5 dark:text-slate-400 dark:hover:text-primary"
                                >
                                    <span className="material-symbols-outlined text-[28px]">close</span>
                                </button>
                                <div className="flex flex-col items-center">
                                    <span className="text-xs font-bold tracking-widest text-primary uppercase opacity-90">인생 포지션</span>
                                </div>
                                <div className="w-10"></div>
                            </div>
                            <div className="flex flex-col gap-2.5">
                                <div className="flex justify-between items-end px-1">
                                    <span className="text-xs font-semibold text-primary/70 dark:text-primary/50 uppercase tracking-wider">질문 단계</span>
                                    <span className="text-sm font-bold text-primary">
                                        {currentIndex + 1}{' '}
                                        <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ {QUESTIONS.length}</span>
                                    </span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(127,19,236,0.3)]" style={{ width: `${progress}%` }}></div>
                                </div>
                                <div className="flex items-center justify-between text-[11px] text-slate-500 dark:text-slate-400 px-1">
                                    <span>질문</span>
                                    <span>사주</span>
                                    <span>타로</span>
                                    <span>결과</span>
                                </div>
                            </div>
                        </header>
                        <main className="flex-1 flex flex-col px-6 relative z-10 overflow-y-auto">
                            <section className="py-10 flex flex-col items-center justify-center min-h-[200px]">
                                <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-primary/10 mb-6 text-primary shadow-sm">
                                    <span className="material-symbols-outlined text-2xl">psychology_alt</span>
                                </div>
                                <h1 className="text-2xl md:text-[26px] font-bold text-slate-900 dark:text-white text-center leading-snug tracking-tight word-keep-all w-full max-w-[320px] line-clamp-2">
                                    {currentQuestion.text}
                                </h1>
                                <p className="mt-3 text-xs text-slate-500 dark:text-slate-400">설문 완료 후 사주 분석 단계로 이동합니다.</p>
                            </section>
                            <section className="flex-1 flex flex-col items-stretch gap-3.5 pb-10 w-full">
                                {Object.entries(currentQuestion.options).map(([key, label]) => (
                                    <label key={key} className="group relative cursor-pointer block touch-manipulation w-full self-stretch">
                                        <input
                                            onChange={() => handleSelect(key)}
                                            className="peer sr-only"
                                            name={`question_${currentIndex}`}
                                            type="radio"
                                            value={key}
                                            checked={selectedChoice === key}
                                        />
                                        <div className="card-ring w-full min-h-[88px] flex items-center gap-4 p-5 py-5 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-surface-dark transition-all duration-200 hover:border-primary/40 dark:hover:border-primary/40 active:scale-[0.99] shadow-sm">
                                            <div className="flex-1 py-1">
                                                <p className="text-[16px] font-medium leading-[1.6] text-slate-700 dark:text-slate-200 group-hover:text-primary dark:group-hover:text-primary transition-colors word-keep-all line-clamp-2">
                                                    {label}
                                                </p>
                                            </div>
                                            <div className="radio-indicator relative shrink-0 w-6 h-6 rounded-full border-2 border-slate-300 dark:border-slate-500 transition-colors duration-200"></div>
                                        </div>
                                    </label>
                                ))}
                            </section>
                        </main>
                        <footer className="p-5 pb-10 relative z-10 flex items-center justify-between gap-3">
                            <button 
                                onClick={() => navigate(-1)}
                                className="group flex items-center gap-2 px-6 py-3 rounded-full text-slate-500 hover:text-primary hover:bg-primary/5 transition-all dark:text-slate-400 dark:hover:text-primary"
                            >
                                <span className="material-symbols-outlined text-lg transition-transform group-hover:-translate-x-1">arrow_back</span>
                                <span className="text-[15px] font-bold tracking-wide">이전 화면</span>
                            </button>
                            <button
                                onClick={handleNextQuestion}
                                disabled={!selectedChoice}
                                className={`h-12 px-6 rounded-2xl font-bold text-[15px] transition-all ${
                                    selectedChoice
                                        ? 'bg-primary text-white shadow-glow active:scale-[0.98]'
                                        : 'bg-slate-200 text-slate-500 dark:bg-slate-800 dark:text-slate-500'
                                }`}
                            >
                                다음
                            </button>
                        </footer>
                </AppScreen>
            );
        };

        // 4. Tarot Selection Screen
        const BACK_THEMES = {
            indigo: 'linear-gradient(135deg, #1f122e 0%, #7f13ec 100%)',
            amber: 'linear-gradient(135deg, #2b1606 0%, #ff8a00 45%, #ff2e63 100%)',
            teal: 'linear-gradient(135deg, #061a2b 0%, #00c2ff 50%, #00f5d4 100%)',
            violet: 'linear-gradient(135deg, #120b22 0%, #7f13ec 100%)',
            crimson: 'linear-gradient(135deg, #24070d 0%, #ff3b6b 100%)',
            rose: 'linear-gradient(135deg, #1f0a1a 0%, #ff4fd8 100%)',
            slate: 'linear-gradient(135deg, #0b1220 0%, #64748b 100%)',
            emerald: 'linear-gradient(135deg, #071c14 0%, #10b981 100%)',
            bronze: 'linear-gradient(135deg, #1f140a 0%, #d97706 100%)',
            red: 'linear-gradient(135deg, #20060a 0%, #ef4444 100%)',
            blue: 'linear-gradient(135deg, #071227 0%, #3b82f6 100%)',
            gray: 'linear-gradient(135deg, #111827 0%, #6b7280 100%)',
            mint: 'linear-gradient(135deg, #06221c 0%, #34d399 100%)',
        };

        const ORIENTATION_LABELS = {
            upright: '정방향',
            reversed: '역방향',
        };
        const MAJOR_THEMES = ['indigo', 'violet', 'crimson', 'rose', 'slate', 'bronze', 'emerald', 'amber', 'teal'];
        const MAJOR_KEYWORDS_KR = {
            'major-0': ['시작', '자유', '모험'],
            'major-1': ['의지', '기술', '실행'],
            'major-2': ['직관', '비밀', '관찰'],
            'major-3': ['풍요', '창조', '돌봄'],
            'major-4': ['질서', '책임', '리더십'],
            'major-5': ['전통', '배움', '신뢰'],
            'major-6': ['선택', '관계', '조화'],
            'major-7': ['전진', '승부', '집중'],
            'major-8': ['용기', '인내', '절제'],
            'major-9': ['탐구', '내면', '고독'],
            'major-10': ['전환', '기회', '순환'],
            'major-11': ['판단', '균형', '정의'],
            'major-12': ['관점', '정지', '희생'],
            'major-13': ['종결', '정리', '변화'],
            'major-14': ['절제', '회복', '조율'],
            'major-15': ['유혹', '집착', '속박'],
            'major-16': ['붕괴', '각성', '리셋'],
            'major-17': ['희망', '치유', '영감'],
            'major-18': ['감정', '불확실', '환상'],
            'major-19': ['성공', '명료', '확장'],
            'major-20': ['각성', '결정', '재시작'],
            'major-21': ['완성', '통합', '성취'],
        };

        const buildUprightMeaning = ({ archetype, korea, strengths, caution, advice, keywords }) => ({
            archetype,
            korea,
            strength: strengths,
            caution,
            advice,
            keywords,
        });

        const buildReversedMeaning = (upright) => ({
            archetype: `${upright.archetype} (역)`,
            korea: `균형이 흔들려 ${upright.archetype}의 과한 면이 드러나기 쉽습니다.`,
            strength: ['현실 점검', '속도 조절', '경계 강화'],
            caution: ['지연', '과해석', '소통 단절'],
            advice: ['우선순위 재정렬', '작게 쪼개어 실행'],
            keywords: (upright.keywords || []).map((item) => `${item} 재점검`),
        });

        const getMeaning = (card, orientation = 'upright') => {
            if (!card?.meaning) return {};
            if (card.meaning.upright) {
                return card.meaning[orientation] || card.meaning.upright;
            }
            return card.meaning;
        };
        const MAJOR_ARCANA = [
            { id: 'major-0', label: '바보', archetype: '시작/자유/모험', korea: '새로운 여정에 열린 마음으로 한 걸음.', strengths: ['유연함', '모험심', '순수한 에너지'], caution: ['충동', '준비 부족'], advice: ['핵심 준비 1개만 챙기고 시작'] },
            { id: 'major-1', label: '마법사', archetype: '의지/집중/실행', korea: '자원과 아이디어를 묶어 현실로 만든다.', strengths: ['실행력', '집중', '설득력'], caution: ['과신', '산만함'], advice: ['오늘은 한 가지에 에너지 집중'] },
            { id: 'major-2', label: '여사제', archetype: '직관/내면/관찰', korea: '말보다 신호를 읽을 때 해답이 나온다.', strengths: ['통찰', '관찰력', '균형감'], caution: ['결정 지연', '숨김'], advice: ['핵심 질문 1개를 적어보기'] },
            { id: 'major-3', label: '여황제', archetype: '풍요/창조/돌봄', korea: '성장할 기회를 키우는 날.', strengths: ['창의', '양육력', '풍요감'], caution: ['과보호', '과소비'], advice: ['자원 배분 기준 1개 세우기'] },
            { id: 'major-4', label: '황제', archetype: '질서/통제/책임', korea: '기준을 세우고 안정감을 만든다.', strengths: ['리더십', '책임감', '조직력'], caution: ['완고함', '지배욕'], advice: ['원칙을 짧게 공유하고 정렬'] },
            { id: 'major-5', label: '교황', archetype: '전통/가르침/신뢰', korea: '검증된 길이 안정감을 준다.', strengths: ['신뢰 구축', '멘토링', '공감'], caution: ['보수성', '의존'], advice: ['검증된 사례 1개 참고'] },
            { id: 'major-6', label: '연인', archetype: '선택/관계/조화', korea: '가치의 정렬이 관계를 선명하게 한다.', strengths: ['협업', '공감', '조율'], caution: ['망설임', '의존'], advice: ['우선순위 1개를 명확히'] },
            { id: 'major-7', label: '전차', archetype: '전진/의지/승리', korea: '방향을 정하면 속도가 붙는다.', strengths: ['추진력', '집중', '승부 근성'], caution: ['과속', '강박'], advice: ['속도보다 방향을 재점검'] },
            { id: 'major-8', label: '힘', archetype: '인내/용기/내면의 힘', korea: '차분한 힘이 큰 결과를 만든다.', strengths: ['인내', '침착', '회복력'], caution: ['억눌림', '고집'], advice: ['감정은 숨기지 말고 정리'] },
            { id: 'major-9', label: '은둔자', archetype: '탐구/정리/내면', korea: '혼자만의 시간에서 해답이 나온다.', strengths: ['분석', '통찰', '절제'], caution: ['고립', '지연'], advice: ['핵심 자료 3개만 정리'] },
            { id: 'major-10', label: '운명의 수레바퀴', archetype: '전환/순환/기회', korea: '변화의 흐름을 타면 기회가 온다.', strengths: ['적응력', '기회 포착', '유연함'], caution: ['우왕좌왕', '통제 불가'], advice: ['지금 흐름에 맞춰 1개 시도'] },
            { id: 'major-11', label: '정의', archetype: '균형/판단/공정', korea: '기준이 명확할수록 결정이 쉬워진다.', strengths: ['판단력', '공정성', '책임감'], caution: ['냉정함', '완벽주의'], advice: ['근거를 2줄로 요약'] },
            { id: 'major-12', label: '매달린 사람', archetype: '지연/관점 전환/희생', korea: '멈춤은 손실이 아니라 재정렬이다.', strengths: ['통찰', '유연성', '인내'], caution: ['정체', '자기희생'], advice: ['관점 전환 질문 1개 적기'] },
            { id: 'major-13', label: '죽음', archetype: '종결/정리/변화', korea: '끝이 있어야 다음이 열린다.', strengths: ['결단', '정리력', '재시작'], caution: ['두려움', '미련'], advice: ['버릴 것 1개 확정'] },
            { id: 'major-14', label: '절제', archetype: '조화/균형/회복', korea: '속도를 조절하면 지속력이 생긴다.', strengths: ['균형감', '회복력', '조율'], caution: ['지연', '애매함'], advice: ['루틴 1개를 고정'] },
            { id: 'major-15', label: '악마', archetype: '집착/유혹/연결', korea: '붙잡는 것을 인식해야 풀린다.', strengths: ['집중', '현실 감각', '욕구 파악'], caution: ['집착', '과의존'], advice: ['집착 요소 1개 거리두기'] },
            { id: 'major-16', label: '탑', archetype: '붕괴/각성/리셋', korea: '무너짐은 새로운 기준을 만든다.', strengths: ['정직함', '리셋 능력', '결단'], caution: ['충격', '혼란'], advice: ['핵심만 남기고 단순화'] },
            { id: 'major-17', label: '별', archetype: '희망/회복/영감', korea: '작은 희망이 방향을 만든다.', strengths: ['희망', '재정렬', '치유'], caution: ['실행 지연', '현실 회피'], advice: ['가장 작은 첫걸음 1개'] },
            { id: 'major-18', label: '달', archetype: '감정/불확실/직관', korea: '흐릿한 감정은 천천히 정리한다.', strengths: ['직관', '감수성', '관찰'], caution: ['과해석', '불안'], advice: ['감정을 한 줄로 적기'] },
            { id: 'major-19', label: '태양', archetype: '성공/명료/확장', korea: '빛나는 자리에서 성과가 커진다.', strengths: ['자신감', '명료함', '에너지'], caution: ['과속', '과신'], advice: ['성과 1개를 공개'] },
            { id: 'major-20', label: '심판', archetype: '각성/결정/재시작', korea: '결정의 시간이 왔다.', strengths: ['결단', '재정렬', '책임감'], caution: ['압박', '과거 집착'], advice: ['결정 이유 1줄로 확정'] },
            { id: 'major-21', label: '세계', archetype: '완성/통합/성취', korea: '마무리와 확장이 동시에 온다.', strengths: ['완성력', '통합', '확장'], caution: ['완주 후 공백'], advice: ['다음 단계 1개 연결'] },
        ].map((card, index) => ({
            deck: 'default',
            id: card.id,
            label: card.label,
            code: `Major ${String(index).padStart(2, '0')}`,
            image: `/assets/images/tarot/default/mager/${index}.jpg`,
            backTheme: MAJOR_THEMES[index % MAJOR_THEMES.length],
            symbol: 'auto_awesome',
            meaning: (() => {
                const upright = buildUprightMeaning({
                    archetype: card.archetype,
                    korea: card.korea,
                    strengths: card.strengths,
                    caution: card.caution,
                    advice: card.advice,
                    keywords: MAJOR_KEYWORDS_KR[card.id] || [],
                });
                return {
                    upright,
                    reversed: buildReversedMeaning(upright),
                };
            })(),
        }));

        const SUIT_META = {
            cups: { label: '컵', symbol: 'water_drop', backTheme: 'teal', keyword: '감정/관계/직관' },
            wands: { label: '완드', symbol: 'local_fire_department', backTheme: 'amber', keyword: '열정/행동/창의' },
            swords: { label: '소드', symbol: 'air', backTheme: 'slate', keyword: '사고/결정/갈등' },
            pentacles: { label: '펜타클', symbol: 'paid', backTheme: 'emerald', keyword: '현실/성과/자원' },
        };

        const RANK_LABELS = {
            1: '에이스',
            2: '2',
            3: '3',
            4: '4',
            5: '5',
            6: '6',
            7: '7',
            8: '8',
            9: '9',
            10: '10',
            11: '페이지',
            12: '기사',
            13: '여왕',
            14: '왕',
        };

        const RANK_THEMES = {
            1: '시작/씨앗',
            2: '균형/선택',
            3: '확장/협업',
            4: '안정/휴식',
            5: '충돌/시험',
            6: '전환/이동',
            7: '전략/평가',
            8: '전개/몰입',
            9: '성과/내면',
            10: '완성/부담',
            11: '학습/메시지',
            12: '추진/여정',
            13: '수용/성숙',
            14: '통제/리더십',
        };

        const buildMinorMeaning = (suit, rank) => {
            const rankTheme = RANK_THEMES[rank] || '전개';
            const upright = buildUprightMeaning({
                archetype: `${suit.label} · ${rankTheme}`,
                korea: `${suit.keyword}의 ${rankTheme}에 초점이 맞춰지는 날.`,
                strengths: [`${suit.label}의 흐름을 빠르게 읽음`, '상황 적응력', '균형 감각'],
                caution: ['과잉 몰입', '결정 지연'],
                advice: ['핵심 우선순위 1개만 잡기', '속도보다 방향 점검'],
                keywords: [suit.label, suit.keyword, rankTheme],
            });
            return {
                upright,
                reversed: buildReversedMeaning(upright),
            };
        };

        const buildSuitCards = (suitKey, suit) => {
            const ranks = Array.from({ length: 14 }, (_, idx) => idx + 1);
            return ranks.map((rank) => ({
                deck: 'default',
                id: `${suitKey}-${rank}`,
                label: `${suit.label} ${RANK_LABELS[rank]}`,
                code: `${suit.label} ${String(rank).padStart(2, '0')}`,
                image: `/assets/images/tarot/default/${suitKey}/${rank}.jpg`,
                backTheme: suit.backTheme,
                symbol: suit.symbol,
                meaning: buildMinorMeaning(suit, rank),
            }));
        };

        const DEFAULT_DECK = [
            ...MAJOR_ARCANA,
            ...buildSuitCards('cups', SUIT_META.cups),
            ...buildSuitCards('wands', SUIT_META.wands),
            ...buildSuitCards('swords', SUIT_META.swords),
            ...buildSuitCards('pentacles', SUIT_META.pentacles),
        ];

        const FLOW_CARDS = DEFAULT_DECK;
        const CORE_CARDS = DEFAULT_DECK;
        const PATTERN_CARDS = DEFAULT_DECK;

        const DECK_ORDER = ['core', 'pattern', 'flow'];

        const deckCards = (deck) => {
            return DEFAULT_DECK;
        };

        const deckSpreadCount = (deck) => {
            if (deck === 'core') return 5;
            if (deck === 'pattern') return 4;
            return 3;
        };

        const sampleCards = (cards, count) => {
            const pool = [...cards];
            for (let i = pool.length - 1; i > 0; i -= 1) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            return pool.slice(0, Math.min(count, pool.length));
        };

        const findCardById = (id) => DEFAULT_DECK.find((card) => card.id === id);

        const CardFront = ({ card, orientation = 'upright' }) => {
            const meaning = getMeaning(card, orientation);
            return (
            <div className="absolute inset-0 rounded-2xl overflow-hidden">
                {card.image ? (
                    <div className="absolute inset-0 bg-cover bg-center opacity-90" style={{ backgroundImage: `url('${card.image}')` }} />
                ) : (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/10">
                        <span className="material-symbols-outlined text-white text-[64px] opacity-90">{card.symbol}</span>
                    </div>
                )}
                <div className="absolute inset-0 bg-gradient-to-b from-black/10 via-transparent to-black/60"></div>
                <div className="absolute top-4 left-4 px-3 py-1 rounded-full bg-white/10 backdrop-blur border border-white/15">
                    <span className="text-[11px] font-bold text-white tracking-widest uppercase">{card.code}</span>
                </div>
                <div className="absolute top-4 right-4 px-3 py-1 rounded-full bg-black/30 backdrop-blur border border-white/10">
                    <span className="text-[10px] font-semibold text-white tracking-widest">{ORIENTATION_LABELS[orientation] || '정방향'}</span>
                </div>
                <div className="absolute bottom-5 left-0 right-0 text-center">
                    <div className="text-white text-xl font-black">{card.label}</div>
                    <div className="text-white/80 text-[11px] font-semibold mt-1 px-4">
                        {meaning?.korea}
                    </div>
                </div>
            </div>
        );
        };

        const CardBack = ({ card }) => (
            <div
                className="absolute inset-0 rounded-2xl border border-white/10"
                style={{ background: BACK_THEMES[card.backTheme] || BACK_THEMES.indigo }}
            >
                <div
                    className="absolute inset-0 opacity-10"
                    style={{
                        backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)',
                        backgroundSize: '20px 20px',
                    }}
                ></div>
                <div className="absolute inset-0 flex items-center justify-center">
                    <div className="w-16 h-16 rounded-full border border-white/20 flex items-center justify-center bg-white/5 backdrop-blur-sm">
                        <span className="material-symbols-outlined text-white/80 text-3xl">{card.symbol}</span>
                    </div>
                </div>
            </div>
        );

        const FlipCard = ({ card, onPick, disabled, revealed, className = '', orientation = 'upright' }) => (
            <button
                disabled={disabled}
                onClick={() => onPick(card)}
                className={`relative w-[150px] h-[225px] sm:w-[170px] sm:h-[250px] rounded-2xl transition-transform active:scale-[0.98] ${className} ${
                    disabled ? 'opacity-70' : 'hover:-translate-y-1'
                }`}
                style={{ perspective: 1000 }}
            >
                <div
                    className="absolute inset-0 transition-transform duration-700"
                    style={{
                        transformStyle: 'preserve-3d',
                        transform: revealed ? 'rotateY(180deg)' : 'rotateY(0deg)',
                    }}
                >
                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden' }}>
                        <CardBack card={card} />
                    </div>
                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                        <CardFront card={card} orientation={orientation} />
                    </div>
                </div>
            </button>
        );

        const CardDetailModal = ({ card, onClose }) => {
            const [flipped, setFlipped] = useState(false);

            useEffect(() => {
                if (!card) return;
                setFlipped(false);
                const timer = setTimeout(() => setFlipped(true), 60);
                return () => clearTimeout(timer);
            }, [card]);

            if (!card) return null;
            const orientation = card.orientation || 'upright';
            const meaning = getMeaning(card, orientation);
            return (
                <div className="fixed inset-0 z-[999] flex items-center justify-center">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-[92%] max-w-md rounded-3xl bg-background-light dark:bg-background-dark border border-slate-200 dark:border-slate-700 shadow-2xl p-6">
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 w-9 h-9 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center"
                        >
                            <span className="material-symbols-outlined text-[22px]">close</span>
                        </button>
                        <div className="flex items-center gap-4 mb-4">
                            <div className="w-16 h-20 shrink-0" style={{ perspective: 600 }}>
                                <div
                                    className="relative w-full h-full rounded-xl overflow-hidden transition-transform duration-700"
                                    style={{ transformStyle: 'preserve-3d', transform: flipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                                >
                                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden' }}>
                                        <CardBack card={card} />
                                    </div>
                                    <div className="absolute inset-0" style={{ backfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                                        <CardFront card={card} />
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="text-xs font-bold tracking-widest text-primary uppercase">{card.code}</div>
                                <h3 className="text-2xl font-black text-slate-900 dark:text-white">{card.label}</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{meaning?.archetype}</p>
                                <p className="mt-1 text-[11px] font-semibold text-primary/80">{ORIENTATION_LABELS[orientation] || '정방향'}</p>
                            </div>
                        </div>
                        <div className="space-y-4 text-sm text-slate-700 dark:text-slate-300">
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">한국 정서</div>
                                <p className="leading-relaxed">{meaning?.korea}</p>
                            </div>
                            {Array.isArray(meaning?.keywords) && meaning.keywords.length > 0 && (
                                <div>
                                    <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">키워드</div>
                                    <p className="leading-relaxed">{meaning.keywords.join(' · ')}</p>
                                </div>
                            )}
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">강점</div>
                                <p className="leading-relaxed">{meaning?.strength?.join(' · ')}</p>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">주의</div>
                                <p className="leading-relaxed">{meaning?.caution?.join(' · ')}</p>
                            </div>
                            <div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">오늘 조언</div>
                                <p className="leading-relaxed">{meaning?.advice?.join(' / ')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TarotScreen = ({ pickedTarots, setPickedTarots }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const birthData = location.state?.birthData || null;
            const [step, setStep] = useState(0);
            const [phase, setPhase] = useState('idle');
            const [spread, setSpread] = useState([]);
            const [stripCards, setStripCards] = useState([]);
            const [pickedThisStep, setPickedThisStep] = useState(null);
            const [detailCard, setDetailCard] = useState(null);
            const stripRef = useRef(null);
            const stripItemRefs = useRef({});

            const deck = DECK_ORDER[step];
            const totalSteps = DECK_ORDER.length;

            useEffect(() => {
                if (pickedTarots.length > 0) {
                    setPickedTarots([]);
                }
                setStep(0);
                setPhase('idle');
                setPickedThisStep(null);
            }, []);

            useEffect(() => {
                const cards = deckCards(deck);
                const stripCount = Math.min(cards.length, 14);
                setStripCards(sampleCards(cards, stripCount));
                setSpread(sampleCards(cards, deckSpreadCount(deck)));
                setPhase('idle');
                setPickedThisStep(null);
            }, [deck]);

            const buildSpreadWithCard = (card) => {
                const cards = deckCards(deck).filter((item) => item.id !== card.id);
                const count = deckSpreadCount(deck);
                const pool = sampleCards(cards, Math.max(0, count - 1));
                const insertIndex = Math.floor(count / 2);
                const next = [...pool];
                next.splice(insertIndex, 0, card);
                return next;
            };

            const playPickSound = () => {
                try {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (!AudioCtx) return;
                    const ctx = new AudioCtx();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(620, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(420, ctx.currentTime + 0.08);
                    gain.gain.setValueAtTime(0.0001, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.12);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.14);
                    osc.onended = () => ctx.close();
                } catch (err) {
                    // ignore sound failures
                }
            };

            const onPick = (card) => {
                if (phase !== 'idle') return;
                const orientation = Math.random() < 0.5 ? 'upright' : 'reversed';
                playPickSound();
                setPickedThisStep({ ...card, orientation });
                setPhase('revealing');
                setPickedTarots((prev) => [...prev, { deck, id: card.id, orientation }]);
                setTimeout(() => setPhase('revealed'), 750);
            };

            const onPickFromStrip = (card) => {
                if (phase !== 'idle') return;
                setSpread(buildSpreadWithCard(card));
                onPick(card);
            };

            const onNext = () => {
                if (step + 1 >= totalSteps) {
                    navigate('/result', { state: { birthData } });
                } else {
                    setStep((prev) => prev + 1);
                }
            };

            const titleMap = {
                core: { title: '정체성 카드', desc: '당신의 기본 역할(코어)을 고르세요.' },
                pattern: { title: '습관 카드', desc: '당신의 행동 방식(패턴)을 고르세요.' },
                flow: { title: '흐름 카드', desc: '오늘의 흐름을 닮은 한 장을 고르세요. (마지막 카드가 지역을 결정합니다)' },
            };
            const revealedTheme = BACK_THEMES[pickedThisStep?.backTheme] || BACK_THEMES.indigo;
            const displaySpread = useMemo(() => {
                if (!pickedThisStep) return spread;
                if (spread.find((card) => card.id === pickedThisStep.id)) return spread;
                if (spread.length === 0) return [pickedThisStep];
                const next = [...spread];
                const centerIndex = Math.floor(next.length / 2);
                next[centerIndex] = pickedThisStep;
                return next;
            }, [spread, pickedThisStep]);

            useEffect(() => {
                if (!pickedThisStep) return;
                const el = stripItemRefs.current[pickedThisStep.id];
                if (!el) return;
                el.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }, [pickedThisStep]);

            const sizeClass =
                displaySpread.length <= 3
                    ? ''
                    : displaySpread.length === 4
                        ? 'w-[132px] h-[200px] sm:w-[150px] sm:h-[225px]'
                        : 'w-[122px] h-[186px] sm:w-[140px] sm:h-[210px]';

            const renderPickCard = (card) => {
                const isSelected = pickedThisStep?.id === card.id;
                const disableOthers = phase !== 'idle' && !isSelected;
                const orientation = isSelected ? pickedThisStep?.orientation || 'upright' : 'upright';
                return (
                    <FlipCard
                        key={card.id}
                        card={card}
                        onPick={onPick}
                        disabled={disableOthers}
                        revealed={isSelected && phase !== 'idle'}
                        className={sizeClass}
                        orientation={orientation}
                    />
                );
            };

            return (
                <AppScreen>
                        <header className="flex items-center justify-between p-4 pb-2">
                            <button
                                onClick={() => navigate(-1)}
                                className="flex size-10 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"
                            >
                                <span className="material-symbols-outlined text-[24px]">arrow_back</span>
                            </button>
                            <div className="text-center">
                                <div className="text-sm font-bold tracking-widest uppercase">타로 선택</div>
                                <div className="text-xs text-slate-500 dark:text-slate-400 font-medium">
                                    {step + 1} / {totalSteps}
                                </div>
                            </div>
                            <button
                                onClick={() => navigate('/')}
                                className="flex size-10 items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800"
                            >
                                <span className="material-symbols-outlined text-[24px]">close</span>
                            </button>
                        </header>

                        <div className="w-full px-6 py-2">
                            <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-primary rounded-full transition-all"
                                    style={{ width: `${((step + 1) / totalSteps) * 100}%` }}
                                ></div>
                            </div>
                        </div>

                        <div className="px-6 pt-2 pb-2">
                            <h1 className="text-2xl font-extrabold tracking-tight text-slate-900 dark:text-white">
                                {titleMap[deck].title}
                            </h1>
                            <p className="text-sm text-slate-600 dark:text-slate-300 mt-1 leading-relaxed break-keep">
                                {titleMap[deck].desc}
                            </p>
                        </div>

                        <div className="px-6 pt-1">
                            <div className="text-center text-sm font-bold tracking-widest uppercase text-slate-500 dark:text-slate-400">
                                선택된 카드: {pickedTarots.length} / {totalSteps}
                            </div>
                            <p className="mt-1 text-[11px] text-center text-slate-400 dark:text-slate-500">
                                좌우로 스크롤해 카드 더미를 확인하고 아래 배치 또는 상단 더미에서 선택하세요.
                            </p>
                        </div>

                        <div className="px-6 pt-3 pb-2">
                            <div ref={stripRef} className="tarot-strip flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                {stripCards.map((card, idx) => {
                                    const isSelected = pickedThisStep?.id === card.id;
                                    const disableOthers = phase !== 'idle' && !isSelected;
                                    return (
                                    <div
                                        key={`${card.id}-${idx}`}
                                        ref={(el) => {
                                            if (el) stripItemRefs.current[card.id] = el;
                                        }}
                                        onClick={() => onPickFromStrip(card)}
                                        className={`tarot-strip-card relative shrink-0 w-[58px] h-[88px] rounded-xl overflow-hidden border border-white/10 shadow-sm cursor-pointer transition-all ${
                                            isSelected ? 'ring-2 ring-primary/70' : ''
                                        } ${disableOthers ? 'opacity-50 pointer-events-none' : 'hover:-translate-y-1'}`}
                                    >
                                        {isSelected && (
                                            <div className="tarot-strip-badge">
                                                선택됨
                                            </div>
                                        )}
                                        <div className="relative w-full h-full">
                                            <CardBack card={card} />
                                        </div>
                                    </div>
                                )})}
                            </div>
                        </div>

                        <main className="flex-1 px-6 pt-2 pb-28 flex flex-col">
                            <div className="flex-1 flex items-center justify-center">
                                {displaySpread.length <= 3 && (
                                    <div className="flex flex-col items-center gap-6">
                                        <div className="flex gap-6">
                                            {displaySpread.slice(0, 2).map(renderPickCard)}
                                        </div>
                                        {displaySpread[2] && renderPickCard(displaySpread[2])}
                                    </div>
                                )}
                                {displaySpread.length === 4 && (
                                    <div className="grid grid-cols-2 gap-5">
                                        {displaySpread.map(renderPickCard)}
                                    </div>
                                )}
                                {displaySpread.length >= 5 && (
                                    <div className="flex flex-col items-center gap-5">
                                        <div className="flex gap-5">
                                            {displaySpread.slice(0, 2).map(renderPickCard)}
                                        </div>
                                        {displaySpread[2] && renderPickCard(displaySpread[2])}
                                        <div className="flex gap-5">
                                            {displaySpread.slice(3, 5).map(renderPickCard)}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="mt-6">
                                <div className="flex items-center justify-between px-1 mb-2">
                                    <div className="text-xs font-bold tracking-widest text-slate-500 dark:text-slate-400 uppercase">
                                        Picked
                                    </div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400">{pickedTarots.length} 장</div>
                                </div>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                    {pickedTarots.map((p, idx) => {
                                        const card = findCardById(p.id);
                                        if (!card) return null;
                                        return (
                                            <div
                                                key={`${p.deck}-${p.id}-${idx}`}
                                                className={`relative shrink-0 w-[64px] h-[92px] rounded-xl border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm ${
                                                    idx === pickedTarots.length - 1 ? 'ring-2 ring-primary/60' : ''
                                                }`}
                                                onClick={() => setDetailCard({ ...card, orientation: p.orientation })}
                                            >
                                                {card.image ? (
                                                    <div className="w-full h-full bg-cover bg-center" style={{ backgroundImage: `url('${card.image}')` }}></div>
                                                ) : (
                                                    <div
                                                        className="w-full h-full flex items-center justify-center"
                                                        style={{ background: BACK_THEMES[card.backTheme] || BACK_THEMES.indigo }}
                                                    >
                                                        <span className="material-symbols-outlined text-white text-[28px]">{card.symbol}</span>
                                                    </div>
                                                )}
                                                {p.orientation && (
                                                    <div className="absolute top-1 left-1 rounded-full bg-black/40 px-1.5 py-0.5 text-[9px] font-semibold text-white">
                                                        {ORIENTATION_LABELS[p.orientation] || '정방향'}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </main>

                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95">
                            <button
                                disabled={phase !== 'revealed'}
                                onClick={onNext}
                                className={`w-full h-14 rounded-2xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                                    phase === 'revealed'
                                        ? 'text-white shadow-glow active:scale-[0.98]'
                                        : 'bg-slate-200 text-slate-500 dark:bg-slate-800 dark:text-slate-500'
                                }`}
                                style={phase === 'revealed' ? { background: revealedTheme } : undefined}
                            >
                                <span>{step + 1 >= totalSteps ? '결과 보기' : '다음 카드 뽑기'}</span>
                                <span className="material-symbols-outlined text-[24px]">arrow_forward</span>
                            </button>
                            <p className="mt-3 text-[11px] text-center text-slate-400 dark:text-slate-500 font-medium">
                                카드 선택은 성향 해석을 위한 상징적 단계입니다.
                            </p>
                        </div>
                        <CardDetailModal card={detailCard} onClose={() => setDetailCard(null)} />
                </AppScreen>
            );
        };

        // 5. Result Screen
        const ResultScreen = ({ pickedTarots }) => {
            const navigate = useNavigate();
            const location = useLocation();
            const birthData = location.state?.birthData || null;

            const pickedCore = pickedTarots.find((item) => item.deck === 'core');
            const pickedPattern = pickedTarots.find((item) => item.deck === 'pattern');
            const pickedFlow = pickedTarots[pickedTarots.length - 1];

            const core = CORE_CARDS.find((card) => card.id === pickedCore?.id) || CORE_CARDS[0];
            const pattern = PATTERN_CARDS.find((card) => card.id === pickedPattern?.id) || PATTERN_CARDS[0];
            const flow = FLOW_CARDS.find((card) => card.id === pickedFlow?.id) || FLOW_CARDS[0];

            const resultMap = {
                aurora_bay: {
                    label: '오로라 해안',
                    badge: 'AURORA BAY / COAST',
                    type: '회복 균형형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '결을 정리하는',
                    tone: 'cool',
                    summary: '잔잔한 흐름 속에서 감정의 결을 정리하고 회복을 우선할 때입니다.',
                    todayLine: '속도를 줄이고 루틴을 되찾는 선택이 가장 빠른 회복으로 이어집니다.',
                },
                han_river: {
                    label: '한강 라인',
                    badge: 'HAN RIVER / CITY',
                    type: '속도 상승형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '판을 키우는',
                    tone: 'neutral',
                    summary: '확장과 집중이 동시에 필요한 날입니다. 핵심 성과를 전면에 두세요.',
                    todayLine: '가장 큰 기회는 ‘지금 공개’에서 나옵니다.',
                },
                pine_ridge: {
                    label: '소나무 능선',
                    badge: 'PINE RIDGE / MOUNTAIN',
                    type: '정돈 집중형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '안개를 걷는',
                    tone: 'mist',
                    summary: '과한 확장보다 구조 정리가 우선인 흐름입니다.',
                    todayLine: '버릴 것을 먼저 정리하면 길이 또렷해집니다.',
                },
                night_market: {
                    label: '야시장 거리',
                    badge: 'NIGHT MARKET / CITY',
                    type: '기회 확장형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '빛을 모으는',
                    tone: 'warm',
                    summary: '사람과 기회가 모이는 흐름입니다. 연결을 넓히세요.',
                    todayLine: '작은 만남이 큰 기회로 이어질 수 있습니다.',
                },
                dawn_field: {
                    label: '새벽 들판',
                    badge: 'DAWN FIELD / COAST',
                    type: '리듬 회복형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '호흡을 맞추는',
                    tone: 'soft',
                    summary: '무리보다 리듬을 되찾는 것이 핵심인 날입니다.',
                    todayLine: '속도를 낮추면 판단이 선명해집니다.',
                },
                cloud_pass: {
                    label: '구름 고개',
                    badge: 'CLOUD PASS / MOUNTAIN',
                    type: '전환 준비형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '길을 다시 잡는',
                    tone: 'mist',
                    summary: '방향을 다시 잡는 시기입니다. 큰 결정을 늦춰도 좋습니다.',
                    todayLine: '정비가 끝나면 선택이 쉬워집니다.',
                },
                harbor_light: {
                    label: '항구 불빛',
                    badge: 'HARBOR LIGHT / COAST',
                    type: '관계 조율형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '파도를 읽는',
                    tone: 'cool',
                    summary: '관계의 흐름을 정리하고 신뢰를 쌓기 좋은 날입니다.',
                    todayLine: '대화의 온도를 낮추면 더 멀리 갑니다.',
                },
                skyline: {
                    label: '스카이라인',
                    badge: 'SKYLINE / CITY',
                    type: '선명 추진형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '성과를 쌓는',
                    tone: 'neutral',
                    summary: '목표를 더 선명히 보일수록 성과가 빠르게 쌓입니다.',
                    todayLine: '한 가지 목표를 공개하면 추진력이 붙습니다.',
                },
                stone_valley: {
                    label: '바위 계곡',
                    badge: 'STONE VALLEY / MOUNTAIN',
                    type: '내공 축적형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '흐름을 다듬는',
                    tone: 'earth',
                    summary: '느리지만 확실한 축적이 가장 강한 무기입니다.',
                    todayLine: '작은 개선이 누적될수록 결과가 커집니다.',
                },
                tide_bridge: {
                    label: '물결 다리',
                    badge: 'TIDE BRIDGE / COAST',
                    type: '연결 강화형',
                    image: '/assets/images/result/character_jeju_coast.svg',
                    adj: '신뢰를 잇는',
                    tone: 'soft',
                    summary: '연결과 협업에서 좋은 흐름이 만들어지는 날입니다.',
                    todayLine: '서로의 강점을 이어붙이면 속도가 납니다.',
                },
                city_pulse: {
                    label: '도심 맥박',
                    badge: 'CITY PULSE / CITY',
                    type: '실행 가속형',
                    image: '/assets/images/result/character_city_twilight.svg',
                    adj: '결정을 밀어붙이는',
                    tone: 'warm',
                    summary: '지금은 속도를 올려도 되는 구간입니다.',
                    todayLine: '결정을 미루지 말고 실행으로 옮기세요.',
                },
                summit_mist: {
                    label: '정상 안개',
                    badge: 'SUMMIT MIST / MOUNTAIN',
                    type: '리셋 정비형',
                    image: '/assets/images/result/character_mountain_mist.svg',
                    adj: '방향을 다듬는',
                    tone: 'mist',
                    summary: '흐름을 리셋하고 방향을 정비하는 데 최적인 날입니다.',
                    todayLine: '비운 자리에 새로운 길이 드러납니다.',
                },
            };

            const coreOrientation = pickedCore?.orientation || 'upright';
            const patternOrientation = pickedPattern?.orientation || 'upright';
            const flowOrientation = pickedFlow?.orientation || 'upright';
            const coreMeaning = getMeaning(core, coreOrientation);
            const patternMeaning = getMeaning(pattern, patternOrientation);
            const flowMeaning = getMeaning(flow, flowOrientation);

            const resultKeys = Object.keys(resultMap);
            const hashSeed = `${core.id}:${pattern.id}:${flow.id}`;
            let hashValue = 0;
            for (let i = 0; i < hashSeed.length; i += 1) {
                hashValue = (hashValue * 31 + hashSeed.charCodeAt(i)) % 100000;
            }
            const selectedResult = resultMap[resultKeys[hashValue % resultKeys.length]];
            const characterNameFallback = `${selectedResult.adj} ${pattern.label} ${core.label}`.replace(/\s+/g, ' ').trim();
            const summaryFallback = selectedResult.summary || flowMeaning.korea;
            const todayLineFallback = selectedResult.todayLine || `${flowMeaning.archetype} 흐름에서, 당신의 강점은 '${coreMeaning.strength?.[0] || '집중'}'로 드러납니다. 다만 '${patternMeaning.caution?.[0] || '과속'}'에 주의하세요.`;
            const localAnalysisFallback = {
                title: characterNameFallback,
                summary: summaryFallback,
                todayLine: todayLineFallback,
                actions: [
                    { title: '20분 정리 산책', description: '움직이면서 오늘의 우선순위 3가지를 정리해 보세요.' },
                    { title: '한 줄 실행 기록', description: '오늘 완료한 1가지를 기록하면 동기 유지에 도움이 됩니다.' },
                ],
            };

            const [analysisResult, setAnalysisResult] = useState(null);
            const [analysisError, setAnalysisError] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [missingImages, setMissingImages] = useState([]);

            const formatBirthDate = (value) => {
                if (!value) {
                    return '정보 없음';
                }
                return value.replace(/-/g, '. ');
            };
            const formatBirthTime = (data) => {
                if (!data) {
                    return '정보 없음';
                }
                if (data.unknownTime) {
                    return '시간 모름';
                }
                if (data.hour == null || data.minute == null) {
                    return '정보 없음';
                }
                return `${data.hour}:${data.minute}`;
            };
            const formatCalendarType = (value) => {
                if (value === 'lunar') {
                    return '음력';
                }
                return '양력';
            };

            const selectedLabels = [
                `${core.label} (${ORIENTATION_LABELS[coreOrientation] || '정방향'})`,
                `${pattern.label} (${ORIENTATION_LABELS[patternOrientation] || '정방향'})`,
                `${flow.label} (${ORIENTATION_LABELS[flowOrientation] || '정방향'})`,
            ];
            const analysisPayload = JSON.stringify({
                birthData,
                pickedTarots: pickedTarots.map((item) => ({ id: item.id, orientation: item.orientation })),
                pickedTarotIds: pickedTarots.map((item) => item.id),
                pickedCards: {
                    core: { ...core, orientation: coreOrientation },
                    pattern: { ...pattern, orientation: patternOrientation },
                    flow: { ...flow, orientation: flowOrientation },
                },
                psychVector: birthData?.psychVector || null,
            });

            useEffect(() => {
                let cancelled = false;
                const runAnalysis = async () => {
                    setIsAnalyzing(true);
                    setAnalysisError('');
                    try {
                        const headers = { 'Content-Type': 'application/json' };
                        const publicApiKey = (window.__PUBLIC_API_KEY || '').trim();
                        if (publicApiKey) {
                            headers['X-API-Key'] = publicApiKey;
                        }

                        const baseCandidates = [];
                        const configuredBase = (window.__API_BASE_URL || '').trim();
                        if (configuredBase) {
                            baseCandidates.push(configuredBase.replace(/\/+$/, ''));
                        }
                        baseCandidates.push('');

                        let data = null;
                        let lastError = null;
                        for (const base of baseCandidates) {
                            const endpoint = `${base}/api/analyze`;
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                headers,
                                body: analysisPayload,
                            });
                            if (response.ok) {
                                data = await response.json();
                                break;
                            }

                            if (response.status === 404 || response.status === 405) {
                                lastError = new Error('AI API 경로가 배포에 연결되지 않았습니다.');
                                continue;
                            }

                            const errorBody = await response.json().catch(() => ({}));
                            lastError = new Error(errorBody.error || `분석 요청 실패 (HTTP ${response.status})`);
                            break;
                        }

                        if (!data) {
                            throw (lastError || new Error('AI 분석 요청에 실패했습니다.'));
                        }

                        if (!cancelled) {
                            setAnalysisResult(data.analysis || null);
                        }
                    } catch (error) {
                        if (!cancelled) {
                            setAnalysisResult(localAnalysisFallback);
                            setAnalysisError('');
                        }
                    } finally {
                        if (!cancelled) {
                            setIsAnalyzing(false);
                        }
                    }
                };
                runAnalysis();
                return () => {
                    cancelled = true;
                };
            }, [analysisPayload]);

            useEffect(() => {
                let cancelled = false;
                const entries = Object.values(resultMap);
                const missing = [];
                let resolved = 0;
                const done = () => {
                    if (!cancelled && resolved === entries.length) {
                        setMissingImages(missing);
                    }
                };
                entries.forEach((entry) => {
                    const img = new Image();
                    img.onload = () => {
                        resolved += 1;
                        done();
                    };
                    img.onerror = () => {
                        missing.push(entry.image);
                        resolved += 1;
                        done();
                    };
                    img.src = entry.image;
                });
                return () => {
                    cancelled = true;
                };
            }, []);

            const characterName = analysisResult?.title || characterNameFallback;
            const summary = analysisResult?.summary || summaryFallback;
            const todayLine = analysisResult?.todayLine || todayLineFallback;
            const advicePrimary = analysisResult?.actions?.[0] || null;
            const adviceSecondary = analysisResult?.actions?.[1] || null;

            const handleWalkAction = () => {
                window.open('https://www.google.com/search?q=20%EB%B6%84+%ED%83%80%EC%9D%B4%EB%A8%B8', '_blank', 'noopener,noreferrer');
            };
            const handleNoteAction = () => {
                const input = window.prompt('오늘 완료한 1가지를 기록해 보세요.');
                if (input == null) {
                    return;
                }
                const memo = input.trim();
                if (!memo) {
                    window.alert('내용을 입력해 주세요.');
                    return;
                }
                const payload = {
                    memo,
                    createdAt: new Date().toISOString(),
                };
                window.localStorage.setItem('life_position_daily_note', JSON.stringify(payload));
                window.alert('기록이 저장되었습니다.');
            };
            const handleShareResult = async () => {
                const shareText = [
                    `선택 카드: ${selectedLabels.join(' -> ')}`,
                    `캐릭터: ${characterName}`,
                    `요약: ${summary}`,
                ].join('\n');
                try {
                    if (navigator.share) {
                        await navigator.share({
                            title: '인생 포지션 분석 결과',
                            text: shareText,
                        });
                        return;
                    }
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(shareText);
                        window.alert('분석 결과가 클립보드에 복사되었습니다.');
                        return;
                    }
                    window.alert(shareText);
                } catch (error) {
                    window.alert(`공유 중 오류가 발생했습니다: ${error?.message || error}`);
                }
            };

            const toneOverlay = {
                cool: 'linear-gradient(180deg, rgba(9,30,66,0.05) 0%, rgba(10,37,63,0.35) 100%)',
                warm: 'linear-gradient(180deg, rgba(69,26,3,0.05) 0%, rgba(120,53,15,0.35) 100%)',
                mist: 'linear-gradient(180deg, rgba(15,23,42,0.05) 0%, rgba(71,85,105,0.35) 100%)',
                soft: 'linear-gradient(180deg, rgba(14,116,144,0.05) 0%, rgba(30,64,175,0.25) 100%)',
                earth: 'linear-gradient(180deg, rgba(30,41,59,0.05) 0%, rgba(99,102,241,0.25) 100%)',
                neutral: 'linear-gradient(180deg, rgba(2,6,23,0.02) 0%, rgba(30,41,59,0.2) 100%)',
            };

            return (
                <AppScreen outerClassName="selection:bg-primary/30" frameClassName="font-display text-slate-900 dark:text-slate-100 mx-auto">
                        <header className="flex items-center px-4 py-3 sticky top-0 z-50 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md border-b border-slate-100/50 dark:border-slate-800/50">
                            <button
                                onClick={() => navigate(-1)}
                                className="text-slate-900 dark:text-slate-100 flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors"
                            >
                                <span className="material-symbols-outlined">arrow_back</span>
                            </button>
                            <h1 className="text-slate-900 dark:text-slate-100 text-base font-bold flex-1 text-center tracking-tight">인생 포지션 분석</h1>
                            <button className="text-slate-900 dark:text-slate-100 flex items-center justify-center w-10 h-10 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                                <span className="material-symbols-outlined">more_vert</span>
                            </button>
                        </header>
                        <main className="min-h-0 flex-1 flex flex-col overflow-y-auto no-scrollbar pb-32 px-5">
                            <div className="mt-3 mb-2">
                                <div className="flex justify-between items-end px-1 mb-2">
                                    <span className="text-[11px] font-semibold text-primary/80 uppercase tracking-wider">결과 단계</span>
                                    <span className="text-sm font-bold text-primary">4 <span className="text-slate-400 dark:text-slate-600 font-light text-xs align-baseline ml-0.5">/ 4</span></span>
                                </div>
                                <div className="h-2 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary rounded-full" style={{ width: '100%' }}></div>
                                </div>
                                <p className="mt-2 text-[11px] text-slate-500 dark:text-slate-400">
                                    선택 카드: {selectedLabels.join(' → ')}
                                </p>
                            </div>
                            {missingImages.length > 0 && (
                                <div className="mt-2 text-[11px] text-amber-600 dark:text-amber-400 bg-amber-50/70 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl px-3 py-2">
                                    누락된 결과 이미지가 있습니다: {missingImages.join(', ')}
                                </div>
                            )}
                            {isAnalyzing && (
                                <p className="mt-1 text-xs font-semibold text-primary">OpenAI 분석 중입니다...</p>
                            )}
                            {analysisError && (
                                <p className="mt-1 text-xs font-semibold text-rose-500">OpenAI 연결 오류: {analysisError}</p>
                            )}
                            <div className="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl p-4 shadow-card text-sm text-slate-600 dark:text-slate-300">
                                <div className="flex items-center justify-between">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">생년월일</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatBirthDate(birthData?.date)}</span>
                                </div>
                                <div className="flex items-center justify-between mt-2">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">태어난 시간</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatBirthTime(birthData)}</span>
                                </div>
                                <div className="flex items-center justify-between mt-2">
                                    <span className="font-semibold text-slate-500 dark:text-slate-400">달력 기준</span>
                                    <span className="font-bold text-slate-900 dark:text-white">{formatCalendarType(birthData?.calendarType)}</span>
                                </div>
                            </div>
                            <div className="relative w-full aspect-[4/5] mt-4 rounded-2xl overflow-hidden shadow-soft group mx-auto max-w-[360px]">
                                <div className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style={{ backgroundImage: `url('${selectedResult.image}')` }}></div>
                                <div className="absolute inset-0 bg-gradient-to-t from-background-light dark:from-background-dark via-transparent to-transparent opacity-80"></div>
                                <div className="absolute inset-0 mix-blend-overlay" style={{ background: toneOverlay[selectedResult.tone] || toneOverlay.neutral }}></div>
                                <div className="absolute top-4 left-4 bg-surface-light/30 dark:bg-surface-dark/30 backdrop-blur-md border border-white/20 px-3 py-1 rounded-full flex items-center gap-1.5 shadow-lg">
                                    <span className="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
                                    <span className="text-[10px] font-bold text-white tracking-widest uppercase">{selectedResult.badge}</span>
                                </div>
                                <div className="absolute bottom-0 left-0 right-0 p-6 flex flex-col items-center text-center translate-y-2">
                                    <div className="inline-block px-3 py-1 mb-2 rounded-full bg-primary/90 backdrop-blur-sm shadow-glow border border-primary/20">
                                        <span className="text-[11px] font-bold text-white uppercase tracking-wider">{selectedResult.type}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-col items-center text-center mt-6 mb-8">
                                <h2 className="text-4xl font-black text-slate-900 dark:text-white leading-[1.1] tracking-tight mb-3">
                                    {characterName}
                                </h2>
                                <div className="h-px w-8 bg-primary/30 my-3"></div>
                                <p className="text-secondary-text dark:text-slate-400 text-sm font-medium italic mt-1 max-w-[300px] leading-relaxed opacity-90">
                                    "{summary}"
                                </p>
                            </div>
                            <div className="space-y-6">
                                <div className="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-card relative overflow-hidden group">
                                    <div className="absolute -right-4 -top-4 w-24 h-24 bg-primary/5 rounded-full blur-2xl pointer-events-none"></div>
                                    <div className="flex items-center gap-2.5 mb-4 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <span className="material-symbols-outlined text-primary text-xl">terminal</span>
                                        <h3 className="text-sm font-bold uppercase tracking-wider text-slate-900 dark:text-white">오늘의 종합 해석</h3>
                                    </div>
                                    <div className="space-y-3">
                                        <div className="flex items-center">
                                            <span className="inline-flex items-center px-2 py-1 rounded bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 text-xs font-bold font-mono">
                                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5 animate-pulse"></span>
                                                STATUS: {flowMeaning.keywords?.[0] || flow.label}
                                            </span>
                                        </div>
                                        <p className="text-sm text-slate-600 dark:text-slate-300 leading-7 font-normal">{todayLine}</p>
                                    </div>
                                </div>
                                <div className="pt-2">
                                    <div className="flex items-center gap-2 mb-4 px-1">
                                        <span className="flex h-2 w-2 relative">
                                            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                                            <span className="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                                        </span>
                                        <h3 className="text-sm font-bold text-slate-900 dark:text-white tracking-tight">오늘의 추천 행동</h3>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        <button
                                            onClick={handleWalkAction}
                                            className="flex items-center p-4 bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm active:scale-[0.98] transition-all group text-left"
                                        >
                                            <div className="w-12 h-12 rounded-xl bg-primary/5 dark:bg-white/5 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors duration-300 shrink-0">
                                                <span className="material-symbols-outlined text-[24px]">smartphone</span>
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <h4 className="text-[15px] font-bold text-slate-900 dark:text-white mb-1 group-hover:text-primary transition-colors">
                                                    {advicePrimary?.title || flowMeaning.advice?.[0]}
                                                </h4>
                                                <p className="text-[13px] text-slate-500 dark:text-slate-400 leading-tight">
                                                    {advicePrimary?.description || coreMeaning.advice?.[0]}
                                                </p>
                                            </div>
                                            <span className="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-lg">arrow_forward_ios</span>
                                        </button>
                                        <button
                                            onClick={handleNoteAction}
                                            className="flex items-center p-4 bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm active:scale-[0.98] transition-all group text-left"
                                        >
                                            <div className="w-12 h-12 rounded-xl bg-primary/5 dark:bg-white/5 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-colors duration-300 shrink-0">
                                                <span className="material-symbols-outlined text-[24px]">edit_note</span>
                                            </div>
                                            <div className="ml-4 flex-1">
                                                <h4 className="text-[15px] font-bold text-slate-900 dark:text-white mb-1 group-hover:text-primary transition-colors">
                                                    {adviceSecondary?.title || flowMeaning.advice?.[1]}
                                                </h4>
                                                <p className="text-[13px] text-slate-500 dark:text-slate-400 leading-tight">
                                                    {adviceSecondary?.description || patternMeaning.advice?.[0]}
                                                </p>
                                            </div>
                                            <span className="material-symbols-outlined text-slate-300 group-hover:text-primary transition-colors text-lg">arrow_forward_ios</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="text-xs text-slate-500 dark:text-slate-400">
                                    선택 카드: {selectedLabels.join(' · ')}
                                </div>
                            </div>
                        </main>
                        <div className="absolute bottom-0 left-0 right-0 w-full p-5 pb-8 bg-gradient-to-t from-background-light via-background-light/95 to-transparent dark:from-background-dark dark:via-background-dark/95 z-40 pointer-events-none h-32 flex items-end">
                            <button
                                onClick={handleShareResult}
                                className="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 px-6 rounded-2xl shadow-glow flex items-center justify-center gap-3 transition-all active:scale-[0.97] pointer-events-auto"
                            >
                                <span className="material-symbols-outlined text-[22px]">ios_share</span>
                                <span className="text-[15px] tracking-wide">분석 결과 공유하기</span>
                            </button>
                        </div>
                </AppScreen>
            );
        };

        // --- App Shell ---
        const App = () => {
            const [pickedTarots, setPickedTarots] = useState([]);
            return (
                <HashRouter>
                    <Routes>
                        <Route path="/" element={<LandingScreen />} />
                        <Route path="/birth" element={<BirthInputScreen />} />
                        <Route path="/analysis" element={<AnalysisScreen />} />
                        <Route path="/tarot" element={<TarotScreen pickedTarots={pickedTarots} setPickedTarots={setPickedTarots} />} />
                        <Route path="/result" element={<ResultScreen pickedTarots={pickedTarots} />} />
                    </Routes>
                </HashRouter>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        window.__APP_RENDERED__ = true;
        } catch (error) {
            const root = document.getElementById('root');
            if (root) {
                root.textContent = `앱 초기화 실패: ${error?.message || error}`;
            }
        }
    </script>
</body>
</html>
